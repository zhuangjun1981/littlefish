
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>littlefish.core.simulation &#8212; littlefish 0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">littlefish 0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for littlefish.core.simulation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">littlefish.core.utilities</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">littlefish.core.terrain</span> <span class="k">as</span> <span class="nn">tr</span>
<span class="kn">import</span> <span class="nn">littlefish.core.fish</span> <span class="k">as</span> <span class="nn">fi</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<div class="viewcode-block" id="simulate_one_fish"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.simulate_one_fish">[docs]</a><span class="k">def</span> <span class="nf">simulate_one_fish</span><span class="p">(</span><span class="n">fish_path</span><span class="p">,</span> <span class="n">simulation_length</span><span class="p">,</span> <span class="n">simulation_num</span><span class="p">,</span> <span class="n">terrain_size</span><span class="p">,</span> <span class="n">sea_level</span><span class="p">,</span> <span class="n">food_num</span><span class="p">,</span> <span class="n">hard_thr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">fish_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fish_num</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the function to simulate a fish&#39;s lives in multiple terrain maps. the simulation results will be saved in the same</span>
<span class="sd">    input path &#39;fish_path&#39;.</span>

<span class="sd">    :param fish_path: str, the path of an hdf5 file, with has a group &#39;fish&#39; in root, which contains data of one and</span>
<span class="sd">                      only one fish. Ideally generated by littlefish.fish.to_h5_group() method.</span>
<span class="sd">    :param simulation_length: positive int, top length of each simulation in time unit.</span>
<span class="sd">    :param simulation_num: positive int, number of terrain maps to simulate</span>
<span class="sd">    :param terrain_size: tuple of two positive ints, pixel size if terrain maps, (row, col)</span>
<span class="sd">    :param sea_level: float, (0., 1.), sea level to define terrain. lower see level will give fish a hard time.</span>
<span class="sd">    :param food_num: non-negative int, how many food pellet(s) are presented at any given time in terrain map.</span>
<span class="sd">    :param hard_thr: positive int, fish should have a life span longer than this threshold to be kept for simulation.</span>
<span class="sd">    :param fish_ind: non-negative int, the index of the current fish in the whole population (generation). just for</span>
<span class="sd">                     printout purpose, if not known, keep 0.</span>
<span class="sd">    :param fish_num: non-negative int, the total number of fish in the whole population (generation). just for</span>
<span class="sd">                     printout purpose, if not known, keep 0.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tg</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">TerrainGenerator</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">terrain_size</span><span class="p">,</span> <span class="n">sea_level</span><span class="o">=</span><span class="n">sea_level</span><span class="p">)</span>

    <span class="n">curr_fish_f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fish_path</span><span class="p">)</span>
    <span class="n">curr_fish</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">Fish</span><span class="o">.</span><span class="n">from_h5_group</span><span class="p">(</span><span class="n">curr_fish_f</span><span class="p">[</span><span class="s1">&#39;fish&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">sim_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">simulation_num</span><span class="p">):</span>
        <span class="n">curr_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">curr_seed</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">curr_seed</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">========================= </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">; fish: </span><span class="si">{}</span><span class="s1"> ; simulation: </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> start ===========================&#39;</span><span class="o">.</span>
            <span class="nb">format</span><span class="p">(</span><span class="n">fish_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fish_num</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sim_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">simulation_num</span><span class="p">))</span>

        <span class="n">curr_terrain_map</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">generate_binary_map</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">is_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">curr_terrain</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">BinaryTerrain</span><span class="p">(</span><span class="n">curr_terrain_map</span><span class="p">)</span>
        <span class="n">curr_simulation</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">terrain</span><span class="o">=</span><span class="n">curr_terrain</span><span class="p">,</span> <span class="n">fish_list</span><span class="o">=</span><span class="p">[</span><span class="n">curr_fish</span><span class="p">],</span>
                                     <span class="n">simulation_length</span><span class="o">=</span><span class="n">simulation_length</span><span class="p">,</span> <span class="n">food_num</span><span class="o">=</span><span class="n">food_num</span><span class="p">)</span>

        <span class="n">curr_simulation</span><span class="o">.</span><span class="n">initiate_simulation</span><span class="p">()</span>
        <span class="n">curr_simulation</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">curr_sim_grp</span> <span class="o">=</span> <span class="n">curr_fish_f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;simulation_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">sim_ind</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">curr_sim_grp</span><span class="p">[</span><span class="s1">&#39;ending_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">_%H_%M_%S&#39;</span><span class="p">)</span>
        <span class="n">curr_sim_grp</span><span class="p">[</span><span class="s1">&#39;random_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_seed</span>
        <span class="n">curr_sim_grp</span><span class="p">[</span><span class="s1">&#39;simulation_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulation_length</span>
        <span class="n">curr_sim_grp</span><span class="p">[</span><span class="s1">&#39;script_txt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">])</span>
        <span class="n">curr_simulation</span><span class="o">.</span><span class="n">save_log_to_h5_grp</span><span class="p">(</span><span class="n">curr_sim_grp</span><span class="p">,</span> <span class="n">is_save_psp_waveforms</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">========================== </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">; fish: </span><span class="si">{}</span><span class="s1">; simulation: </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> end ============================&#39;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">fish_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fish_num</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sim_ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">simulation_num</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">curr_simulation</span><span class="o">.</span><span class="n">_end_t</span> <span class="o">&lt;</span> <span class="n">hard_thr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulation: fish life span was less than the hard threshold. end the simulation of current&quot;</span>
                  <span class="s2">&quot;fish: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">break</span>

    <span class="n">curr_fish_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simulation class takes fish(s) and terrain to run the simulation of a fish&#39;s activity during its life</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terrain</span><span class="p">,</span> <span class="n">fish_list</span><span class="p">,</span> <span class="n">simulation_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">food_num</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        designed to run only once after creation</span>

<span class="sd">        :param terrain: terrain object, current terrain.terrain_2d.BinaryTerrain object</span>
<span class="sd">        :param fish_list: list of fish object (fish.fish.Fish class)</span>
<span class="sd">        :param simulation_length: positive integer, number of time points of the simulation</span>
<span class="sd">        :param food_num: positive integer, number of food pixels in food map</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># simulation status: 0: not initialized yet;</span>
        <span class="c1">#                    1: started initialization</span>
        <span class="c1">#                    2: initialization finished</span>
        <span class="c1">#                    3: started simulation</span>
        <span class="c1">#                    4: after simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span> <span class="o">=</span> <span class="n">terrain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span> <span class="o">=</span> <span class="n">fish_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span> <span class="o">=</span> <span class="n">simulation_length</span>

        <span class="k">if</span> <span class="n">food_num</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">food_num</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Simulation: food_num should be a positive integer.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_food_num</span> <span class="o">=</span> <span class="n">food_num</span>

<div class="viewcode-block" id="Simulation.initiate_simulation"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.initiate_simulation">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initiate simulation, check simulation status, creating simulation history variables</span>

<span class="sd">        :param simulation_length: int, number of time points of the simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1">#  generate food map, food position history and initial food positions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_food_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">get_terrain_shape</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>

            <span class="n">fish_movement_num</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">:</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_food_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)})</span>

            <span class="c1">#  generate non-overlapping positions for all fish</span>
            <span class="n">fish_start_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">generate_fish_starting_position</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">))</span>

            <span class="c1">#  for each fish generate action histories, psp waveforms and life history</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fish</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">):</span>
                <span class="n">simulation_history_curr_fish</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">simulation_history_curr_fish</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;action_histories&#39;</span><span class="p">:</span> <span class="n">fish</span><span class="o">.</span><span class="n">_brain</span><span class="o">.</span><span class="n">generate_empty_action_histories</span><span class="p">()})</span>
                <span class="n">simulation_history_curr_fish</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">:</span> <span class="n">fish</span><span class="o">.</span><span class="n">_brain</span><span class="o">.</span><span class="n">generate_empty_psp_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span><span class="p">)})</span>
                <span class="n">simulation_history_curr_fish</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;total_moves&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

                <span class="n">life_history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;pos_row&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
                                                                                        <span class="p">(</span><span class="s1">&#39;pos_col&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">),</span>
                                                                                        <span class="p">(</span><span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)]))</span>

                <span class="n">start_position</span> <span class="o">=</span> <span class="n">fish_start_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">life_history</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pos_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">life_history</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">life_history</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fish</span><span class="o">.</span><span class="n">_max_health</span>

                <span class="n">simulation_history_curr_fish</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;life_history&#39;</span><span class="p">:</span> <span class="n">life_history</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">fish</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">simulation_history_curr_fish</span><span class="p">})</span>

            <span class="c1">#  simulation initialization finished, change simulation status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Cannot initiate simulation. Already initialized.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.get_simulation_status"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.get_simulation_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_simulation_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">terrain_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">get_terrain_shape</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simulation_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fish_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">food_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_food_num</span>

<div class="viewcode-block" id="Simulation.generating_fish_map"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.generating_fish_map">[docs]</a>    <span class="k">def</span> <span class="nf">generating_fish_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_point</span><span class="p">,</span> <span class="n">is_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generating fish map containing all fishes according to self._fish_list at time_point</span>

<span class="sd">        :param time_point: non-negative int, time_point in the simulation</span>
<span class="sd">        :param is_plot: bool</span>

<span class="sd">        return: fish_map, 2d array, uint16,</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
            <span class="n">fish_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terrain_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fish_name</span><span class="p">,</span> <span class="n">fish_history</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">curr_health</span> <span class="o">=</span> <span class="n">fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time_point</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">curr_health</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">curr_row</span><span class="p">,</span> <span class="n">curr_col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time_point</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pos_row&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]])</span>
                    <span class="n">curr_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_row</span><span class="p">);</span> <span class="n">curr_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_col</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">curr_row</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">curr_row</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">terrain_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> \
                        <span class="p">(</span><span class="n">curr_col</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">curr_col</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">terrain_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation: cannot plot fish </span><span class="si">{}</span><span class="s1">. Position out of terrain boundary&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fish_name</span><span class="p">))</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="n">fish_map</span><span class="p">[</span><span class="n">curr_row</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">curr_row</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">curr_col</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">curr_col</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">is_plot</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fish_map</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;fish map at time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_point</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">fish_map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Cannot generate fish_map. Simulation not initialized properly.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.get_fish_health_status"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.get_fish_health_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_fish_health_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check the health status of all the fish in the simulation at the time point, t_point.</span>
<span class="sd">        if the time point is not simulated (at least one fish position is [0, 0]), an error will raise.</span>

<span class="sd">        :param t_point: non-negative integer, time point to evaluate</span>
<span class="sd">        :param verbose: bool, if True, print the health_status</span>
<span class="sd">        :return: dataframe, with index = fish_name, column=[&#39;health&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">health_status</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fish_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">fish_n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fish_names</span><span class="p">:</span>

            <span class="n">fish_life_his</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">fish_n</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">fish_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_row&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fish_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Try to get fish health status at an unsimulated time point.&quot;</span><span class="p">)</span>

            <span class="n">health_status</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fish_n</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fish_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">health_status</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">health_status</span></div>

<div class="viewcode-block" id="Simulation.is_all_fish_dead"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.is_all_fish_dead">[docs]</a>    <span class="k">def</span> <span class="nf">is_all_fish_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if the health of all fish are no higher than 0. at t_point in the simulation</span>
<span class="sd">        if the time point is not simulated (at least one fish position is [0, 0]), an error will raise.</span>

<span class="sd">        :param t_point: non-negative integer, time point to evaluate</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">health_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fish_health_status</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">health_status</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_is_dead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fish_n</span><span class="p">,</span> <span class="n">t_point</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check if the health of a single fish is no higher than 0. in the simulation</span>
<span class="sd">        if the time point is not simulated (at least one fish position is [0, 0]), an error will raise.</span>

<span class="sd">        :param fish_n: str, name of the fish</span>
<span class="sd">        :param t_point: non-negative integer, time point to evaluate</span>
<span class="sd">        :return: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">fish_n</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_row&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">fish_n</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Try to get fish health status at an unsimulated time point.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">fish_n</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.</span>

    <span class="k">def</span> <span class="nf">_get_fish_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">fish_history</span><span class="p">):</span>

        <span class="n">curr_position</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_row&#39;</span><span class="p">]),</span>
                         <span class="nb">int</span><span class="p">(</span><span class="n">fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">])]</span>
        <span class="n">curr_health</span> <span class="o">=</span> <span class="n">fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_point</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">curr_position</span><span class="p">,</span> <span class="n">curr_health</span>

    <span class="k">def</span> <span class="nf">_move_fish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_fish</span><span class="p">,</span> <span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_pos</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">,</span> <span class="n">movement_attempt</span><span class="p">):</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># no movement attempt</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">movement_attempt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)):</span>
            <span class="n">new_pos</span> <span class="o">=</span> <span class="n">curr_pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># update fish&#39;s body center postion at curr_t + 1</span>
            <span class="n">new_pos_row</span> <span class="o">=</span> <span class="n">curr_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_attempt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_pos_row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pos_row</span><span class="p">])</span>
            <span class="n">new_pos_row</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">new_pos_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terrain_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">new_pos_col</span> <span class="o">=</span> <span class="n">curr_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_attempt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">new_pos_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">new_pos_col</span><span class="p">])</span>
            <span class="n">new_pos_col</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">new_pos_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terrain_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span>

            <span class="n">new_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_pos_row</span><span class="p">,</span> <span class="n">new_pos_col</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">new_pos</span> <span class="o">!=</span> <span class="n">curr_pos</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;Time: </span><span class="si">{:08d}</span><span class="s1">; Fish: </span><span class="si">{}</span><span class="s1">; Health: </span><span class="si">{:3.4f}</span><span class="s1">; move from [</span><span class="si">{:3d}</span><span class="s1">, </span><span class="si">{:3d}</span><span class="s1">] to [</span><span class="si">{:3d}</span><span class="s1">, </span><span class="si">{:3d}</span><span class="s1">].&#39;</span><span class="o">.</span>\
                    <span class="nb">format</span><span class="p">(</span><span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">,</span> <span class="n">curr_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">new_pos</span><span class="p">,</span> <span class="n">msg</span>

<div class="viewcode-block" id="Simulation.run"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param verbose:</span>
<span class="sd">        :return: print out message as a string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="c1"># at t0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">curr_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">start of simulation. start time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>\
                <span class="nb">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>

            <span class="n">alive_fish_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">)</span>
            <span class="n">curr_t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">curr_progress</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># percentage finished, for printing the simulation progress</span>

            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">alive_fish_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">curr_t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span><span class="p">:</span>

                <span class="c1"># print simulation progress</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">curr_t</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">curr_progress</span><span class="p">:</span>
                        <span class="n">curr_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{:09.2f}</span><span class="s1"> second: </span><span class="si">{:2d}</span><span class="s1"> %&#39;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">,</span> <span class="p">(</span><span class="n">curr_t</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>
                        <span class="n">curr_progress</span> <span class="o">=</span> <span class="n">curr_t</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span> <span class="o">//</span> <span class="mi">10</span><span class="p">)</span>

                <span class="c1"># update food position</span>
                <span class="n">curr_food_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">update_food_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">food_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_food_map</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">][</span><span class="n">curr_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_food_positions</span>

                <span class="n">dead_fish_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fish is going to die at curr_t</span>

                <span class="k">for</span> <span class="n">curr_fish</span> <span class="ow">in</span> <span class="n">alive_fish_list</span><span class="p">:</span>  <span class="c1"># loop through current live fish</span>

                    <span class="c1"># get current fish status</span>
                    <span class="n">curr_fish_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">curr_position</span><span class="p">,</span> <span class="n">curr_health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fish_status</span><span class="p">(</span><span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_fish_history</span><span class="p">)</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">curr_t</span><span class="p">,</span>
                                      <span class="n">curr_position</span><span class="o">=</span><span class="n">curr_position</span><span class="p">,</span>
                                      <span class="n">curr_health</span><span class="o">=</span><span class="n">curr_health</span><span class="p">,</span>
                                      <span class="n">action_histories</span><span class="o">=</span><span class="n">curr_fish_history</span><span class="p">[</span><span class="s1">&#39;action_histories&#39;</span><span class="p">],</span>
                                      <span class="n">psp_waveforms</span><span class="o">=</span><span class="n">curr_fish_history</span><span class="p">[</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">],</span>
                                      <span class="n">terrain_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">_terrain_map</span><span class="p">,</span>
                                      <span class="n">food_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_food_map</span><span class="p">,</span> <span class="n">fish_map</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

                    <span class="n">updated_health</span><span class="p">,</span> <span class="n">movement_attempt</span><span class="p">,</span> <span class="n">food_eated</span> <span class="o">=</span> <span class="n">_</span>

                    <span class="c1"># print eat food message</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">food_eated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">curr_msg</span> <span class="o">=</span> <span class="s2">&quot;Time: </span><span class="si">{:08d}</span><span class="s2">; Fish: </span><span class="si">{}</span><span class="s2">; eated </span><span class="si">{}</span><span class="s2"> food pellet(s). HP: </span><span class="si">{:3.4f}</span><span class="s2"> -&gt; </span><span class="si">{:3.4f}</span><span class="s2">.&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">food_eated</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">,</span>
                                                                <span class="n">updated_health</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">curr_t</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if not at the end of simulation</span>

                        <span class="c1"># update fish&#39;s health at curr_t + 1</span>
                        <span class="n">curr_fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_health</span>

                        <span class="k">if</span> <span class="n">updated_health</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if not dead</span>
                            <span class="n">new_pos</span><span class="p">,</span> <span class="n">curr_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move_fish</span><span class="p">(</span><span class="n">curr_fish</span><span class="p">,</span> <span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_position</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">,</span>
                                                                <span class="n">movement_attempt</span><span class="o">=</span><span class="n">movement_attempt</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">curr_msg</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;total_moves&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>

                            <span class="n">curr_fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pos_row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">curr_fish_history</span><span class="p">[</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">curr_msg</span> <span class="o">=</span> <span class="s2">&quot;Time: </span><span class="si">{:08d}</span><span class="s2">; Fish: </span><span class="si">{}</span><span class="s2">; health: </span><span class="si">{:3.4f}</span><span class="s2">; position:[</span><span class="si">{:3d}</span><span class="s2">,</span><span class="si">{:3d}</span><span class="s2">]&quot;</span><span class="o">.</span>\
                                    <span class="nb">format</span><span class="p">(</span><span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">updated_health</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if dead</span>
                            <span class="n">curr_msg</span> <span class="o">=</span> <span class="s1">&#39;Time: </span><span class="si">{:08d}</span><span class="s1">; Fish: </span><span class="si">{}</span><span class="s1"> died. Total number of movements: </span><span class="si">{}</span><span class="s1">&#39;</span>\
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_t</span><span class="p">,</span> <span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;total_moves&#39;</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>
                            <span class="n">dead_fish_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_fish</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span> <span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">for</span> <span class="n">dead_fish</span> <span class="ow">in</span> <span class="n">dead_fish_list</span><span class="p">:</span>
                    <span class="n">alive_fish_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dead_fish</span><span class="p">)</span>

                <span class="n">curr_t</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_end_t</span> <span class="o">=</span> <span class="n">curr_t</span>

                <span class="k">if</span> <span class="n">curr_t</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_length</span><span class="p">:</span>
                    <span class="n">curr_msg</span> <span class="o">=</span> <span class="s2">&quot;Simulation: End of Simulation. Prespecified simulation length reached.</span><span class="se">\n</span><span class="s2">&quot;</span>

                    <span class="k">for</span> <span class="n">sur_fish</span> <span class="ow">in</span> <span class="n">alive_fish_list</span><span class="p">:</span>
                        <span class="n">add_msg</span> <span class="o">=</span> <span class="s2">&quot;Survived fish: </span><span class="si">{}</span><span class="s2">. Final health: </span><span class="si">{}</span><span class="s2">. Total number of movements: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">sur_fish</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">sur_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">sur_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;total_moves&#39;</span><span class="p">])</span>
                        <span class="n">curr_msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">add_msg</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">alive_fish_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span> <span class="n">curr_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">curr_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Simulation: End of Simulation. All fish are dead. &quot;</span> \
                               <span class="s2">&quot;Last simulated time point: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curr_t</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">curr_msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">curr_msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Cannot run simulation. Simulation not initialized properly.&quot;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Simulation.save_log"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.save_log">[docs]</a>    <span class="k">def</span> <span class="nf">save_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_folder</span><span class="p">,</span> <span class="n">is_save_psp_waveforms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save simulation results into a hdf5 file</span>

<span class="sd">        :param log_folder: directory path to save save_log</span>
<span class="sd">        :param msg: str, print out string</span>
<span class="sd">        :param is_save_psp_waveforms:</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">save_name</span> <span class="o">=</span> <span class="s1">&#39;simulation_&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">_%H_%M_%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_folder</span><span class="p">)</span>
            <span class="n">log_f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_folder</span><span class="p">,</span> <span class="n">save_name</span><span class="p">))</span>
            <span class="n">log_f</span><span class="p">[</span><span class="s1">&#39;terrain_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">_terrain_map</span>
            <span class="n">log_f</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>

            <span class="n">end_t_dset</span> <span class="o">=</span> <span class="n">log_f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;last_time_point&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_t</span><span class="p">)</span>
            <span class="n">end_t_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;the last time point simulated.&#39;</span>

            <span class="n">food_pos_dset</span> <span class="o">=</span> <span class="n">log_f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">,</span>
                                                 <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">])</span>
            <span class="n">food_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_points x food_num x food position [row, col]&#39;</span>

            <span class="n">fish_list_grp</span> <span class="o">=</span> <span class="n">log_f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;fish_list&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">curr_fish</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">:</span>

                <span class="n">curr_fish_grp</span> <span class="o">=</span> <span class="n">fish_list_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># save data of current fish</span>
                <span class="n">curr_fish_fish_grp</span> <span class="o">=</span> <span class="n">curr_fish_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;fish&#39;</span><span class="p">)</span>
                <span class="n">curr_fish</span><span class="o">.</span><span class="n">to_h5_group</span><span class="p">(</span><span class="n">curr_fish_fish_grp</span><span class="p">)</span>
                <span class="n">curr_fish_fish_grp</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Data of the little.fish.fish.Fish object. The object can &#39;</span> \
                                                          <span class="s1">&#39;be loaded by Fish.from_h5_group() method.&#39;</span>

                <span class="c1"># create group to save simulation history of current fish</span>
                <span class="n">curr_fish_sim_grp</span> <span class="o">=</span> <span class="n">curr_fish_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;sim_history&#39;</span><span class="p">)</span>
                <span class="n">curr_sim_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

                <span class="c1"># save total moves</span>
                <span class="n">curr_fish_grp</span><span class="p">[</span><span class="s1">&#39;total_moves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;total_moves&#39;</span><span class="p">]</span>

                <span class="c1"># save action histories of every neuron in current fish</span>
                <span class="n">curr_fish_ah_grp</span> <span class="o">=</span> <span class="n">curr_fish_sim_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;action_histories&#39;</span><span class="p">)</span>
                <span class="n">curr_fish_ah</span> <span class="o">=</span> <span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;action_histories&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">neuron_ind</span><span class="p">,</span> <span class="n">ah</span> <span class="ow">in</span> <span class="n">curr_fish_ah</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">curr_fish_ah_grp</span><span class="p">[</span><span class="s1">&#39;neuron_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ah</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">is_save_psp_waveforms</span><span class="p">:</span>
                    <span class="c1"># save psp waveforms of all neurons in current fish</span>
                    <span class="n">curr_fish_psp_wf_dset</span> <span class="o">=</span> <span class="n">curr_fish_sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">,</span>
                                                                             <span class="n">data</span><span class="o">=</span><span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">])</span>
                    <span class="n">curr_fish_psp_wf_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neuron_ind x time_point&#39;</span>

                <span class="c1"># save life history of fish</span>
                <span class="n">curr_life_his</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span>
                <span class="n">curr_pos_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curr_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;pos_row&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]])</span>
                <span class="n">curr_fish_pos_dset</span> <span class="o">=</span> <span class="n">curr_fish_sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;position_history&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_pos_arr</span><span class="p">)</span>
                <span class="n">curr_fish_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_point x center position [row, col]&#39;</span>
                <span class="n">curr_health_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curr_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;health&#39;</span><span class="p">])</span>
                <span class="n">curr_fish_sim_grp</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_health_arr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Cannot save save_log. Simulation has not run yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Simulation.save_log_to_h5_grp"><a class="viewcode-back" href="../../../littlefish.core.simulation.html#littlefish.core.simulation.Simulation.save_log_to_h5_grp">[docs]</a>    <span class="k">def</span> <span class="nf">save_log_to_h5_grp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_grp</span><span class="p">,</span> <span class="n">is_save_psp_waveforms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save simulation results into a hdf5 group</span>

<span class="sd">        :param h5_grp, hdf5 group object</span>
<span class="sd">        :param msg: str, print out string</span>
<span class="sd">        :param is_save_psp_waveforms:</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Simulation: Cannot save log to a hdf5 group. More than one fish in self._fish_list. &#39;</span>
                          <span class="s1">&#39;The save_log_to_h5_grp() function only designed to save log of simulation contain only &#39;</span>
                          <span class="s1">&#39;one fish.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_status</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>

            <span class="n">curr_fish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fish_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr_sim_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

            <span class="n">sim_grp</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;simulation_log&#39;</span><span class="p">)</span>
            <span class="n">sim_grp</span><span class="p">[</span><span class="s1">&#39;terrain_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terrain</span><span class="o">.</span><span class="n">_terrain_map</span>
            <span class="n">sim_grp</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>

            <span class="n">sim_grp</span><span class="p">[</span><span class="s1">&#39;total_moves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;total_moves&#39;</span><span class="p">]</span>

            <span class="n">food_pos_dset</span> <span class="o">=</span> <span class="n">sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">,</span>
                                                  <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="s1">&#39;food_pos_history&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
                                                  <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
            <span class="n">food_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_points x food_num x food position [row, col]&#39;</span>

            <span class="n">end_t_dset</span> <span class="o">=</span> <span class="n">sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;last_time_point&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_t</span><span class="p">)</span>
            <span class="n">end_t_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;the last time point simulated.&#39;</span>

            <span class="c1"># save action histories of every neuron in current fish</span>
            <span class="n">curr_fish_ah_grp</span> <span class="o">=</span> <span class="n">sim_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;action_histories&#39;</span><span class="p">)</span>
            <span class="n">curr_fish_ah</span> <span class="o">=</span> <span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;action_histories&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">neuron_ind</span><span class="p">,</span> <span class="n">ah</span> <span class="ow">in</span> <span class="n">curr_fish_ah</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">curr_fish_ah_grp</span><span class="p">[</span><span class="s1">&#39;neuron_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ah</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">is_save_psp_waveforms</span><span class="p">:</span>
                <span class="c1"># save psp waveforms of all neurons in current fish</span>
                <span class="n">curr_fish_psp_wf_dset</span> <span class="o">=</span> <span class="n">sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">,</span>
                                                              <span class="n">data</span><span class="o">=</span><span class="n">curr_sim_history</span><span class="p">[</span><span class="s1">&#39;psp_waveforms&#39;</span><span class="p">])</span>
                <span class="n">curr_fish_psp_wf_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neuron_ind x time_point&#39;</span>

            <span class="c1"># save life history of fish</span>
            <span class="n">curr_life_his</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_histories</span><span class="p">[</span><span class="n">curr_fish</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;life_history&#39;</span><span class="p">]</span>

            <span class="n">curr_pos_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curr_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;pos_row&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_col&#39;</span><span class="p">]])</span>
            <span class="n">curr_fish_pos_dset</span> <span class="o">=</span> <span class="n">sim_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;position_history&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_pos_arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span>
                                                       <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">)</span>
            <span class="n">curr_fish_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_point x center position [row, col]&#39;</span>

            <span class="n">curr_health_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">curr_life_his</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;health&#39;</span><span class="p">])</span>
            <span class="n">sim_grp</span><span class="p">[</span><span class="s1">&#39;health&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_health_arr</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Simulation: Cannot save save_log. Simulation has not run yet.&quot;</span><span class="p">)</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="kn">import</span> <span class="nn">littlefish.core.terrain</span> <span class="k">as</span> <span class="nn">tr</span>
    <span class="kn">import</span> <span class="nn">littlefish.core.fish</span> <span class="k">as</span> <span class="nn">fi</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">tg</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">TerrainGenerator</span><span class="p">()</span>
    <span class="n">terrain_map</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">generate_binary_map</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span> <span class="n">is_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">terrain</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">BinaryTerrain</span><span class="p">(</span><span class="n">terrain_map</span><span class="p">)</span>
    <span class="n">fish</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">Fish</span><span class="p">()</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">terrain</span><span class="o">=</span><span class="n">terrain</span><span class="p">,</span> <span class="n">fish_list</span><span class="o">=</span><span class="p">[</span><span class="n">fish</span><span class="p">],</span>
                     <span class="n">simulation_length</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">food_num</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">initiate_simulation</span><span class="p">()</span>
    <span class="c1"># print(sim._simulation_histories)</span>
    <span class="c1"># sim.generating_fish_map(time_point=0, is_plot=True)</span>
    <span class="c1"># sim.get_fish_health_status(0, verbose=True)</span>
    <span class="c1"># print(sim.is_all_fish_dead(0))</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># -------------------------------------------------------------------------</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;for debug&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">littlefish 0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Jun Zhuang.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>