
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>littlefish.core.fish &#8212; littlefish 0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">littlefish 0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for littlefish.core.fish</h1><div class="highlight"><pre>
<span></span><span class="c1"># from __future__ import (absolute_import, division,</span>
<span class="c1">#                         print_function, unicode_literals)</span>
<span class="c1"># from builtins import *</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">littlefish.core</span> <span class="k">import</span> <span class="n">utilities</span> <span class="k">as</span> <span class="n">util</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># unnecessary global varible</span>
<span class="c1">#</span>
<span class="c1"># SIMULATION_LENGTH = 100000</span>
<span class="c1">#</span>
<span class="c1"># EYE_GAIN = 0.005</span>
<span class="c1"># EYE_BASELINE_RATE = 0.</span>
<span class="c1"># EYE_REFRACTORY_PERIOD = 10</span>
<span class="c1"># EYE_BORDER_VALUE = 1</span>
<span class="c1"># EYE_INPUT_FILTER = np.array([0.2, 0.6, 0.2])</span>
<span class="c1"># EYE2_INPUT_FILTER = np.array([0.15, 0.3, 0.15, 0.1, 0.2, 0.1])</span>
<span class="c1"># EYE_DIRECTIONS = [&#39;east&#39;, &#39;northeast&#39;, &#39;north&#39;, &#39;northwest&#39;, &#39;west&#39;, &#39;southwest&#39;, &#39;south&#39;, &#39;southeast&#39;]</span>
<span class="c1"># EYE_INPUT_TYPES = [&#39;terrain&#39;, &#39;food&#39;, &#39;fish&#39;]</span>
<span class="c1">#</span>
<span class="c1"># NEURON_REFRACTORY_PERIOD = 10</span>
<span class="c1"># NEURON_BASELINE_RATE = 0.0001</span>
<span class="c1">#</span>
<span class="c1"># MUSCLE_DIRECTIONS = [&#39;east&#39;, &#39;north&#39;, &#39;west&#39;, &#39;south&#39;]</span>
<span class="c1"># MUSCLE_REFRACTORY_PERIOD = 5000</span>
<span class="c1"># MUSCLE_BASELINE_RATE = 0.00001</span>
<span class="c1">#</span>
<span class="c1"># CONNECTION_LATENCY = 30</span>
<span class="c1"># CONNECTION_AMPLITUDE = 0.0001</span>
<span class="c1"># CONNECTION_RISE_TIME = 50</span>
<span class="c1"># CONNECTION_DECAY_TIME = 100</span>
<span class="c1">#</span>
<span class="c1"># FISH_MAX_HEALTH = 100.</span>
<span class="c1"># FISH_HEALTH_DECAY_RATE = 0.0001</span>
<span class="c1"># FISH_LAND_PENALTY_RATE = 0.005</span>
<span class="c1"># FISH_FOOD_RATE = 20</span>

<div class="viewcode-block" id="generate_minimal_brain"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.generate_minimal_brain">[docs]</a><span class="k">def</span> <span class="nf">generate_minimal_brain</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :return: a Brain object with one eye, two neuron in hidden layer and one muscle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">eye</span> <span class="o">=</span> <span class="n">Eye</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="n">input_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
              <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>

    <span class="n">hidden0</span> <span class="o">=</span> <span class="n">Neuron</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
    <span class="n">hidden1</span> <span class="o">=</span> <span class="n">Neuron</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
    <span class="n">muscle</span> <span class="o">=</span> <span class="n">Muscle</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">neurons</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eye</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hidden0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hidden1</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">muscle</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">])</span>

    <span class="n">connection_eye_hidden0</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">connection_eye_hidden1</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">connection_hidden0_muscle</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">connection_hidden1_muscle</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">conn_0_1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">connection_eye_hidden0</span><span class="p">],</span> <span class="p">[</span><span class="n">connection_eye_hidden1</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">conn_1_2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">connection_hidden0_muscle</span><span class="p">,</span> <span class="n">connection_hidden1_muscle</span><span class="p">]],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">connections</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;L000_L001&#39;</span><span class="p">:</span> <span class="n">conn_0_1</span><span class="p">,</span>
                   <span class="s1">&#39;L001_L002&#39;</span><span class="p">:</span> <span class="n">conn_1_2</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">Brain</span><span class="p">(</span><span class="n">neurons</span><span class="o">=</span><span class="n">neurons</span><span class="p">,</span> <span class="n">connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_standard_fish"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.generate_standard_fish">[docs]</a><span class="k">def</span> <span class="nf">generate_standard_fish</span><span class="p">():</span>

    <span class="c1"># ================================== generate neurons =========================================</span>
    <span class="n">neurons</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">])</span>

    <span class="n">neuron_ind</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">layer_ind</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># generate eyes</span>
    <span class="n">eye_num</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">for</span> <span class="n">eye_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eye_num</span><span class="p">):</span>
        <span class="n">curr_eye_dir</span><span class="p">,</span> <span class="n">curr_eye_input_type</span> <span class="o">=</span> <span class="n">get_eye_type</span><span class="p">(</span><span class="n">eye_ind</span><span class="p">,</span> <span class="n">dir_num</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1"># print curr_eye_dir, curr_eye_input_type</span>
        <span class="n">curr_eye</span> <span class="o">=</span> <span class="n">Eye</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">curr_eye_dir</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="n">curr_eye_input_type</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                       <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eye_ind</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_eye</span>
        <span class="n">neuron_ind</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># generate hidden layers</span>
    <span class="n">layer_ind</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">hid_nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># each number is number of neurons in each hidden layer, default is one hidden layer with 8 neurons</span>
    <span class="k">for</span> <span class="n">hid_num</span> <span class="ow">in</span> <span class="n">hid_nums</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">hid_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hid_num</span><span class="p">):</span>
            <span class="n">curr_neuron</span> <span class="o">=</span> <span class="n">Neuron</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
            <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_ind</span>
            <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hid_ind</span>
            <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_neuron</span>
            <span class="n">neuron_ind</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">layer_ind</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># generate muscles</span>
    <span class="n">mus_num</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">mus_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mus_num</span><span class="p">):</span>
        <span class="n">curr_mus_dir</span> <span class="o">=</span> <span class="n">get_muscle_direction</span><span class="p">(</span><span class="n">mus_ind</span><span class="p">)</span>
        <span class="n">curr_muscle</span> <span class="o">=</span> <span class="n">Muscle</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">curr_mus_dir</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">50.</span><span class="p">)</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_ind</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mus_ind</span>
        <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_muscle</span>
        <span class="n">neuron_ind</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># ================================== generate neurons =========================================</span>

    <span class="c1"># ================================== generate connections =========================================</span>
    <span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">default_connection</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])))</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">pre_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">post_layer</span> <span class="o">=</span> <span class="n">pre_layer</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">post_neuron_inds</span> <span class="o">=</span> <span class="n">neurons</span><span class="p">[</span><span class="n">neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">post_layer</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">post_neuron_inds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">pre_neuron_inds</span> <span class="o">=</span> <span class="n">neurons</span><span class="p">[</span><span class="n">neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pre_layer</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pre_neuron_inds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">curr_name</span> <span class="o">=</span> <span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">post_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># curr_df = pd.DataFrame([[default_connection] * len(pre_neuron_inds)] * len(post_neuron_inds),</span>
        <span class="c1">#                        columns=pre_neuron_inds, index=post_neuron_inds)</span>
        <span class="n">curr_conn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">pre_neuron_inds</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">post_neuron_inds</span><span class="p">)</span>
        <span class="n">curr_conn_df</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">default_connection</span>
        <span class="n">connections</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">curr_name</span><span class="p">:</span> <span class="n">curr_conn_df</span><span class="p">})</span>

    <span class="c1"># print connections</span>
    <span class="c1"># ================================== generate connections =========================================</span>

    <span class="c1"># generate standard brain</span>
    <span class="n">standard_brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">(</span><span class="n">neurons</span><span class="o">=</span><span class="n">neurons</span><span class="p">,</span> <span class="n">connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Fish</span><span class="p">(</span><span class="n">mother_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="n">standard_brain</span><span class="p">,</span> <span class="n">max_health</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">health_decay_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">land_penalty_rate</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">food_rate</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_eye_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.get_eye_type">[docs]</a><span class="k">def</span> <span class="nf">get_eye_type</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">dir_num</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given the neuron_ind in the eye layer return direction and input type of a specific eye</span>

<span class="sd">    :param ind: non-negative int, index of the eye in eye layer</span>
<span class="sd">    :param dir_num: 4 or 8, if 4, eye directions iterate through 4 cardinal directions; if 8, eye directions will</span>
<span class="sd">                    iterate through 8 directions</span>
<span class="sd">    :return: two strings, (direction, type)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">dir_num</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">eye_directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;northeast&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;northwest&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span> <span class="s1">&#39;southwest&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">,</span> <span class="s1">&#39;southeast&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">dir_num</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">eye_directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot understand dir_num, should be 4 or 8.&#39;</span><span class="p">)</span>

    <span class="n">eye_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;fish&#39;</span><span class="p">]</span>
    <span class="n">direction_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eye_directions</span><span class="p">)</span>
    <span class="n">type_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eye_types</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eye_directions</span><span class="p">[</span><span class="n">ind</span> <span class="o">%</span> <span class="n">direction_num</span><span class="p">],</span> <span class="n">eye_types</span><span class="p">[(</span><span class="n">ind</span> <span class="o">//</span> <span class="n">direction_num</span><span class="p">)</span> <span class="o">%</span> <span class="n">type_num</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_muscle_direction"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.get_muscle_direction">[docs]</a><span class="k">def</span> <span class="nf">get_muscle_direction</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    given the neuron_ind in the muscle layer return direction of a specific muscle</span>

<span class="sd">    :return: string, direction of the muscle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">muscle_directions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;west&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">]</span>
    <span class="n">direction_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">muscle_directions</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">muscle_directions</span><span class="p">[</span><span class="n">ind</span> <span class="o">%</span> <span class="n">direction_num</span><span class="p">]</span></div>


<div class="viewcode-block" id="Neuron"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron">[docs]</a><span class="k">class</span> <span class="nc">Neuron</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    a very simple neuron class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        action is the equivalent of action potential in biology, and consider one time unit is 0.1 milisecond</span>

<span class="sd">        :param baseline_rate: float, probablity of a action per time unit.</span>
<span class="sd">        :param refractory_period: float, refractory_period in time unit</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">baseline_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">refractory_period</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;littlefish.brain.Neuron object&#39;</span>

<div class="viewcode-block" id="Neuron.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Neuron</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baseline_rate</span><span class="p">(),</span> <span class="n">refractory_period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_refractory_period</span><span class="p">())</span></div>

<div class="viewcode-block" id="Neuron.get_baseline_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.get_baseline_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_baseline_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span></div>

<div class="viewcode-block" id="Neuron.get_refractory_period"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.get_refractory_period">[docs]</a>    <span class="k">def</span> <span class="nf">get_refractory_period</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span></div>

<div class="viewcode-block" id="Neuron.get_neuron_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.get_neuron_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_neuron_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;neuron&#39;</span></div>

<div class="viewcode-block" id="Neuron.set_baseline_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.set_baseline_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_baseline_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_baseline_rate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_baseline_rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="Neuron.set_refractory_period"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.set_refractory_period">[docs]</a>    <span class="k">def</span> <span class="nf">set_refractory_period</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_refractory_period</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span> <span class="o">=</span> <span class="n">new_refractory_period</span></div>

<div class="viewcode-block" id="Neuron.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="p">[],</span> <span class="n">probability_input</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">probability_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        evaluate if the neuron will fire at given time point</span>

<span class="sd">        :param t_point: int, current time point as the index of time unit axis</span>
<span class="sd">        :param action_history: list of positive integers, list of time stamps of actions of this neuron,</span>
<span class="sd">                               should be monotonically increasing</span>
<span class="sd">        :param probability_input: float, summed connection inputs, as add on to baseline_rate</span>
<span class="sd">        :param probability_base: float, a random number no less than 0 and less than 1, to determine if the neuron</span>
<span class="sd">                                 is going to act or not, if None, a random number will be generated by</span>
<span class="sd">                                 random.random()</span>
<span class="sd">        :return: bool, True: fire; False: quite</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">probability_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">probability_base</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

        <span class="c1"># this block of code is commented out to speed up simulation</span>
        <span class="c1"># else:</span>
        <span class="c1">#     if probability_base &lt; 0. or probability_base &gt;= 1.:</span>
        <span class="c1">#         raise ValueError(&#39;Neuron: probability_base should be no less than 0 and less than 1.&#39;)</span>

        <span class="c1"># this block of code is commented out to speed up simulation</span>
        <span class="c1"># if len(action_history) &gt;= 2:</span>
        <span class="c1">#     if not util.check_monotonicity(np.array(action_history), direction=&#39;increasing&#39;):</span>
        <span class="c1">#         raise ValueError(&#39;Neuron: action history should be monotonically increasing.&#39;)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t_point</span> <span class="o">-</span> <span class="n">action_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span> <span class="o">+</span> <span class="n">probability_input</span>
            <span class="k">if</span> <span class="n">probability_base</span> <span class="o">&lt;=</span> <span class="n">curr_rate</span><span class="p">:</span>
                <span class="n">action_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_point</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Neuron.to_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.to_h5_group">[docs]</a>    <span class="k">def</span> <span class="nf">to_h5_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_group</span><span class="p">):</span>

        <span class="n">br_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span><span class="p">)</span>
        <span class="n">br_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;action_per_time_unit&#39;</span>
        <span class="n">rp_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span><span class="p">)</span>
        <span class="n">rp_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_unit&#39;</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;neuron&#39;</span></div>

<div class="viewcode-block" id="Neuron.from_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Neuron.from_h5_group">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_h5_group</span><span class="p">(</span><span class="n">h5_group</span><span class="p">):</span>

        <span class="n">neuron_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">neuron_type</span> <span class="o">!=</span> <span class="s1">&#39;neuron&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Neuron: loading from h5 file failed. &quot;neuron_type&quot; attribute should be &quot;neuron&quot;.&#39;</span><span class="p">)</span>

        <span class="n">neuron</span> <span class="o">=</span> <span class="n">Neuron</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">refractory_period</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">neuron</span></div></div>


<div class="viewcode-block" id="Eye"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye">[docs]</a><span class="k">class</span> <span class="nc">Eye</span><span class="p">(</span><span class="n">Neuron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eye class to observe the environment and the inside of fish body, subclass of Neuron, has eye sight as 2 pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">input_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">input_type</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="n">refractory_period</span><span class="o">=</span><span class="mf">1.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for a fish occupies 3x3 space, consider the eyes are in the outer rim of the body (the 4 pixels surrounding the</span>
<span class="sd">        central pixel in 4 cardinal direction. Each eye receives the inputs from the given direction in the environment.</span>
<span class="sd">        for example:</span>

<span class="sd">        fish (1) in the environment(0):</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 1 1 1 0 0</span>
<span class="sd">        0 0 1 1 1 0 0</span>
<span class="sd">        0 0 1 1 1 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>

<span class="sd">        eye (2) in the east direction is:</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 1 1 1 0 0</span>
<span class="sd">        0 0 1 1 2 0 0</span>
<span class="sd">        0 0 1 1 1 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>
<span class="sd">        0 0 0 0 0 0 0</span>

<span class="sd">        it receive inputs from pixels labelled as 3 in the environment:</span>
<span class="sd">        0 0 0 0 0 0 3</span>
<span class="sd">        0 0 0 0 0 3 3</span>
<span class="sd">        0 0 0 0 3 3 3</span>
<span class="sd">        0 0 0 3 3 3 3</span>
<span class="sd">        0 0 0 0 3 3 3</span>
<span class="sd">        0 0 0 0 0 3 3</span>
<span class="sd">        0 0 0 0 0 0 3</span>

<span class="sd">        the inputs from the environment (1x16 array) will be filtered by a array with same size, to generate</span>
<span class="sd">        a single value as the base of its input. this value will be multiplied by a float number gain to generate</span>
<span class="sd">        final input probability.</span>

<span class="sd">        self._get_input_pixels will pick pixels within the eye&#39;s receptive field in the following order:</span>
<span class="sd">        0 0 0 0 0 0 10</span>
<span class="sd">        0 0 0 0 0 5 11</span>
<span class="sd">        0 0 0 0 2 6 12</span>
<span class="sd">        0 0 0 1 3 7 13</span>
<span class="sd">        0 0 0 0 4 8 14</span>
<span class="sd">        0 0 0 0 0 9 15</span>
<span class="sd">        0 0 0 0 0 0 16</span>

<span class="sd">        :param direction: str, the aim of the eye, should be one of the following, &#39;east&#39;, &#39;north&#39;, &#39;west&#39; and &#39;south&#39;</span>
<span class="sd">        :param input_filter: 1d array, shape: (16,), filter to transform input pixel values to a single number.</span>
<span class="sd">                             analog of linear receptive field of a retinal ganglion cell. default input_filter is</span>
<span class="sd">                             set as the following:</span>

<span class="sd">                             input_filter[pixel_i] = exp(-1 * cartesian_distance(pixel_i, pixel_body_center)</span>
<span class="sd">        :param baseline_rate: float, probablity of a action per time unit.</span>
<span class="sd">        :param refractory_period: float, refractory_period in time unit</span>
<span class="sd">        :param input_type: str, type of the input the eye receives, should be one of &#39;terrain&#39;, &#39;food&#39;, &#39;fish&#39;,</span>
<span class="sd">               default: &#39;terrain&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rf_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rf_positions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_filter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.243116734</span><span class="p">,</span> <span class="mf">0.367879441</span><span class="p">,</span> <span class="mf">0.243116734</span><span class="p">,</span> <span class="mf">0.059105747</span><span class="p">,</span> <span class="mf">0.106877926</span><span class="p">,</span>
                                           <span class="mf">0.135335283</span><span class="p">,</span> <span class="mf">0.106877926</span><span class="p">,</span> <span class="mf">0.059105747</span><span class="p">,</span> <span class="mf">0.014369596</span><span class="p">,</span> <span class="mf">0.027172461</span><span class="p">,</span> <span class="mf">0.04232922</span><span class="p">,</span>
                                           <span class="mf">0.049787068</span><span class="p">,</span> <span class="mf">0.04232922</span><span class="p">,</span> <span class="mf">0.027172461</span><span class="p">,</span> <span class="mf">0.014369596</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_filter</span> <span class="o">=</span> <span class="n">input_filter</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;fish&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_input_type</span> <span class="o">=</span> <span class="n">input_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Eye: type should be one of the following: &quot;terrain&quot;, &quot;food&quot;, &quot;fish&quot;.&#39;</span><span class="p">)</span>

        <span class="n">curr_baseline_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">baseline_rate</span><span class="p">)</span>
        <span class="n">curr_refractory_period</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">refractory_period</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Eye</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="n">curr_baseline_rate</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="n">curr_refractory_period</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;littlefish.brain.Eye object&#39;</span>

<div class="viewcode-block" id="Eye.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Eye</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(),</span> <span class="n">input_filter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_input_filter</span><span class="p">(),</span> <span class="n">gain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_gain</span><span class="p">(),</span>
                   <span class="n">input_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_input_type</span><span class="p">(),</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baseline_rate</span><span class="p">(),</span>
                   <span class="n">refractory_period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_refractory_period</span><span class="p">())</span></div>

<div class="viewcode-block" id="Eye.get_direction"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span></div>

<div class="viewcode-block" id="Eye.get_input_filter"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.get_input_filter">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_filter</span></div>

<div class="viewcode-block" id="Eye.get_gain"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.get_gain">[docs]</a>    <span class="k">def</span> <span class="nf">get_gain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span></div>

<div class="viewcode-block" id="Eye.get_input_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.get_input_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_type</span></div>

<div class="viewcode-block" id="Eye.get_neuron_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.get_neuron_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_neuron_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;eye&#39;</span></div>

    <span class="k">def</span> <span class="nf">_get_rf_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get pixel coordinate of receptive field</span>

<span class="sd">        :return rf_positions: 2d array, shape: (16, 2), _dtype: int64. each row is a pixel in the receptive field,</span>
<span class="sd">                              [row, col] relative to the position of the body center pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">array1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">array2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;east&#39;</span><span class="p">:</span>
            <span class="n">rf_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">array2</span><span class="p">,</span> <span class="n">array1</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span>
            <span class="n">rf_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">array1</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">array2</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;west&#39;</span><span class="p">:</span>
            <span class="n">rf_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">array2</span><span class="p">,</span> <span class="n">array1</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;south&#39;</span><span class="p">:</span>
            <span class="n">rf_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">array1</span><span class="p">,</span> <span class="n">array2</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Eye: direction should be one of the following: [&#39;east&#39;, &#39;north&#39;, &#39;west&#39;, &#39;south&#39;].&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rf_pos</span>

    <span class="k">def</span> <span class="nf">_get_input_pixels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_map</span><span class="p">,</span> <span class="n">body_position</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get a 1d array of all pixels within the eye&#39;s receptive field</span>

<span class="sd">        :param input_map: 2d array, the map the eye is looking</span>
<span class="sd">        :param body_position: list of two non-negative integers, [row, col] location of body center pixel</span>
<span class="sd">        :param border_value: float, values for pixels outside the border of input_map</span>
<span class="sd">        :return: the 1d array with the values of the 16 pixels in the eye&#39;s receptive field. pixels out of the</span>
<span class="sd">        input_map range will be returned as border_value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">body_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">body_position</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">input_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">curr_pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rf_positions</span><span class="p">):</span>
            <span class="n">curr_rf_pos</span> <span class="o">=</span> <span class="n">body_pos</span> <span class="o">+</span> <span class="n">curr_pos</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr_rf_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">curr_rf_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">input_pixels</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">border_value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_pixels</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_map</span><span class="p">[</span><span class="n">curr_rf_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">curr_rf_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">input_pixels</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">border_value</span>

        <span class="k">return</span> <span class="n">input_pixels</span>

    <span class="k">def</span> <span class="nf">_get_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_map</span><span class="p">,</span> <span class="n">body_position</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: float, calculate real time input from the visual field</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">input_pixels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_input_pixels</span><span class="p">(</span><span class="n">input_map</span><span class="p">,</span> <span class="n">body_position</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="n">border_value</span><span class="p">)</span>
        <span class="n">probability_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gain</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">input_pixels</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_filter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">probability_input</span>

<div class="viewcode-block" id="Eye.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">body_position</span><span class="p">,</span> <span class="n">input_map</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="p">[],</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">probability_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        evaluate if the eye neuron will fire at given time point</span>

<span class="sd">        :param t_point: int, current time point as the index of time unit axis</span>
<span class="sd">        :param body_position: tuple of two ints, (row, col),  position of the body center pixel</span>
<span class="sd">        :param input_map: binary 2-d map, for now it should only contain 0s and 1s</span>
<span class="sd">        :param action_history: list of positive integers, list of time stamps of actions of this neuron,</span>
<span class="sd">                               should be monotonically increasing</span>
<span class="sd">        :param border_value: int, default 1, value for pixels outside the terrain_map</span>
<span class="sd">        :param probability_base: float, a random number no less than 0 and less than 1, to determine if the neuron</span>
<span class="sd">                                 is going to act or not, if None, a random number will be generated by</span>
<span class="sd">                                 random.random()</span>
<span class="sd">        :return: bool, True: fire; False: quite</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">probability_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_input</span><span class="p">(</span><span class="n">input_map</span><span class="o">=</span><span class="n">input_map</span><span class="p">,</span> <span class="n">body_position</span><span class="o">=</span><span class="n">body_position</span><span class="p">,</span>
                                            <span class="n">border_value</span><span class="o">=</span><span class="n">border_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Eye</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="n">action_history</span><span class="p">,</span> <span class="n">probability_input</span><span class="o">=</span><span class="n">probability_input</span><span class="p">,</span>
                                    <span class="n">probability_base</span><span class="o">=</span><span class="n">probability_base</span><span class="p">)</span></div>

<div class="viewcode-block" id="Eye.to_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.to_h5_group">[docs]</a>    <span class="k">def</span> <span class="nf">to_h5_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_group</span><span class="p">):</span>

        <span class="n">br_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span><span class="p">)</span>
        <span class="n">br_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;action_per_time_unit&#39;</span>
        <span class="n">rp_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span><span class="p">)</span>
        <span class="n">rp_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_unit&#39;</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">)</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;input_filter&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_filter</span><span class="p">)</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_gain</span><span class="p">)</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;input_type&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_type</span><span class="p">)</span>
        <span class="n">rf_pos_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;rf_positions&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rf_positions</span><span class="p">)</span>
        <span class="n">rf_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;data_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;16 (pixel_num) x 2 ([row, col])&#39;</span>
        <span class="n">rf_pos_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;coordinates of each pixel of this eye&#39;s receptive field relative to body &quot;</span> \
                                           <span class="s2">&quot;center position&quot;</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;eye&#39;</span></div>

<div class="viewcode-block" id="Eye.from_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Eye.from_h5_group">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_h5_group</span><span class="p">(</span><span class="n">h5_group</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;eye&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Eye: loading from h5 file failed. &quot;neuron_type&quot; attribute should be &quot;eye&quot;.&#39;</span><span class="p">)</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;input_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">eye</span> <span class="o">=</span> <span class="n">Eye</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">input_filter</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;input_filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                  <span class="n">input_type</span><span class="o">=</span><span class="n">input_type</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                  <span class="n">refractory_period</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eye</span></div></div>


<div class="viewcode-block" id="Muscle"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle">[docs]</a><span class="k">class</span> <span class="nc">Muscle</span><span class="p">(</span><span class="n">Neuron</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    muscle class for determining the motion of the fish. Subclass of Neuron class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="mf">500.</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">=</span> <span class="n">direction</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;east&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;west&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span> <span class="o">==</span> <span class="s1">&#39;south&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_step_motion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;self.direction should be one of the following: &quot;</span>
                             <span class="s2">&quot;[&#39;east&#39;, &#39;north&#39;, &#39;west&#39;, &#39;south&#39;].&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Muscle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">baseline_rate</span><span class="o">=</span><span class="n">baseline_rate</span><span class="p">,</span> <span class="n">refractory_period</span><span class="o">=</span><span class="n">refractory_period</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;littlefish.brain.Muscle object&#39;</span>

<div class="viewcode-block" id="Muscle.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Muscle</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_direction</span><span class="p">(),</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_baseline_rate</span><span class="p">(),</span>
                      <span class="n">refractory_period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_refractory_period</span><span class="p">())</span></div>

<div class="viewcode-block" id="Muscle.get_neuron_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.get_neuron_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_neuron_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;muscle&#39;</span></div>

<div class="viewcode-block" id="Muscle.get_direction"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.get_direction">[docs]</a>    <span class="k">def</span> <span class="nf">get_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_direction</span></div>

<div class="viewcode-block" id="Muscle.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="p">[],</span> <span class="n">probability_input</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">probability_base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        evaluate if the muscle will try to move the fish or not</span>

<span class="sd">        :param t_point: int, current time point as the index of time unit axis</span>
<span class="sd">        :param probability_input: float, summed connection inputs, as add on to baseline_rate</span>
<span class="sd">        :param action_history: list of positive integers, list of time stamps of actions of this neuron,</span>
<span class="sd">                               should be monotonically increasing</span>
<span class="sd">        :param probability_base: float, a random number no less than 0 and less than 1, to determine if the neuron</span>
<span class="sd">                                 is going to act or not, if None, a random number will be generated by</span>
<span class="sd">                                 random.random()</span>
<span class="sd">        :return: no attempt: False</span>
<span class="sd">                 attempt: movement vector, 1d array with two ints, [row_update, col_update]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">is_act</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Muscle</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="n">action_history</span><span class="p">,</span> <span class="n">probability_input</span><span class="o">=</span><span class="n">probability_input</span><span class="p">,</span>
                                         <span class="n">probability_base</span><span class="o">=</span><span class="n">probability_base</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_act</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_step_motion</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">is_act</span></div>

<div class="viewcode-block" id="Muscle.to_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.to_h5_group">[docs]</a>    <span class="k">def</span> <span class="nf">to_h5_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_group</span><span class="p">):</span>

        <span class="n">br_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_baseline_rate</span><span class="p">)</span>
        <span class="n">br_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;action_per_time_unit&#39;</span>
        <span class="n">rp_dset</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_refractory_period</span><span class="p">)</span>
        <span class="n">rp_dset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;time_unit&#39;</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_direction</span><span class="p">)</span>
        <span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;muscle&#39;</span></div>

<div class="viewcode-block" id="Muscle.from_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Muscle.from_h5_group">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_h5_group</span><span class="p">(</span><span class="n">h5_group</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;muscle&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Muscle: loading from h5 file failed. &quot;neuron_type&quot; attribute should be &quot;muscle&quot;.&#39;</span><span class="p">)</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">muscle</span> <span class="o">=</span> <span class="n">Muscle</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">baseline_rate</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;baseline_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">refractory_period</span><span class="o">=</span><span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;refractory_period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">muscle</span></div></div>


<div class="viewcode-block" id="Connection"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection">[docs]</a><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    synaptic connection between two neurons</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latency</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param latency: int, temporal latency from presynaptic neuron action to the postsynaptic effect onset, number</span>
<span class="sd">                        of time units</span>
<span class="sd">        :param amplitude: float, peak change of the firing rate in the postsynaptic neuron, probablity of a action per</span>
<span class="sd">                          time unit. can be positive (excitatiory) or negative (inhibitory)</span>
<span class="sd">        :param rise_time: int, temporal duration from onset to peak, number of time units</span>
<span class="sd">        :param decay_time: int, temporal duration from peak to baseline, number of time units</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">latency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">latency</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;latency should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">latency</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rise_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">rise_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;rise_time should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rise_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">decay_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">decay_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;decay_time should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">decay_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;littlefish.brain.Connection object&#39;</span>

<div class="viewcode-block" id="Connection.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_latency</span><span class="p">(),</span> <span class="n">amplitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_amplitude</span><span class="p">(),</span> <span class="n">rise_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(),</span>
                          <span class="n">decay_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_decay_time</span><span class="p">())</span></div>

<div class="viewcode-block" id="Connection.get_latency"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.get_latency">[docs]</a>    <span class="k">def</span> <span class="nf">get_latency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latency</span></div>

<div class="viewcode-block" id="Connection.set_latency"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.set_latency">[docs]</a>    <span class="k">def</span> <span class="nf">set_latency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_latency</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_latency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">new_latency</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new_latency should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latency</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_latency</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.get_amplitude"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.get_amplitude">[docs]</a>    <span class="k">def</span> <span class="nf">get_amplitude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span></div>

<div class="viewcode-block" id="Connection.set_ampletude"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.set_ampletude">[docs]</a>    <span class="k">def</span> <span class="nf">set_ampletude</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_amplitude</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_amplitude</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.get_rise_time"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.get_rise_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_rise_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span></div>

<div class="viewcode-block" id="Connection.set_rise_time"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.set_rise_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_rise_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_rise_time</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_rise_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">new_rise_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new_rise should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_rise_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span></div>

<div class="viewcode-block" id="Connection.get_decay_time"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.get_decay_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_decay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span></div>

<div class="viewcode-block" id="Connection.set_decay_time"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.set_decay_time">[docs]</a>    <span class="k">def</span> <span class="nf">set_decay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_decay_time</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_decay_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_integer</span><span class="p">(</span><span class="n">new_decay_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;new_decay should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_decay_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_generate_psp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        generate post synaptic probability wave form</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_latency</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_latency</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_latency</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span><span class="p">[</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span><span class="p">)</span>

<div class="viewcode-block" id="Connection.get_psp"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.get_psp">[docs]</a>    <span class="k">def</span> <span class="nf">get_psp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span></div>

<div class="viewcode-block" id="Connection.set_params"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.set_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rise_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decay_time</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set new parameters and regenerate psp waveform</span>

<span class="sd">        :param latency: int, number of time units for time delay</span>
<span class="sd">        :param amplitude: float, peak probability</span>
<span class="sd">        :param rise_time: int, number of time units to rise to peak</span>
<span class="sd">        :param decay_time: int, number of time units to decay to baseline</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">latency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">latency</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;latency should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_latency</span> <span class="o">=</span> <span class="n">latency</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">rise_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rise_time</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;rise_time should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rise_time</span> <span class="o">=</span> <span class="n">rise_time</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">decay_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">decay_time</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;decay_time should be an integer.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_decay_time</span> <span class="o">=</span> <span class="n">decay_time</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_psp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain.Connection: no parameter has been changed. Do nothing.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Connection.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Connection.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">postsynaptic_index</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        if the presynaptic neuron fires at the &#39;time_point&#39;, a psp wave form will be generated and add to the</span>
<span class="sd">        input waveform of postsynaptic neuron defined by postsynaptic_index</span>

<span class="sd">        :param t_point: int, current time point as the index of time unit axis</span>
<span class="sd">        :param postsynaptic_index: non-negative int, the index of postsynaptic neuron</span>
<span class="sd">        :param psp_waveforms: 2-d array, float 32, the psp waveforms of all neurons in the brain, neuron id x t-point,</span>
<span class="sd">                              the generated psp will be added to the postsynaptic_index th line of the array</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">psp_end</span> <span class="o">=</span> <span class="n">t_point</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_psp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psp_end</span> <span class="o">&lt;=</span> <span class="n">psp_waveforms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">psp_waveforms</span><span class="p">[</span><span class="n">postsynaptic_index</span><span class="p">,</span> <span class="n">t_point</span><span class="p">:</span> <span class="n">psp_end</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psp_waveforms</span><span class="p">[</span><span class="n">postsynaptic_index</span><span class="p">,</span> <span class="n">t_point</span><span class="p">:]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psp</span><span class="p">[:</span><span class="n">psp_waveforms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_point</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Brain"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain">[docs]</a><span class="k">class</span> <span class="nc">Brain</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    brain class, the neural network from eye to muscle</span>

<span class="sd">    a &#39;brain&#39; has a couple of sets of 8 eyes (brain.Eye object, each at each border pixel of the body). each set of</span>
<span class="sd">    eyes are receiving inputs from different objects. i.e. one set of eyes will look at land/water, another set of eyes</span>
<span class="sd">    will look for food, another set of eyes will look for other fish.</span>

<span class="sd">    a &#39;brain&#39; has 4 invisible muscles (brain.Muscle object, each controlling the movement in each direction).</span>

<span class="sd">    between eyes and muscles are a neural network consists of neurons (brain.Neuron object) and connections</span>
<span class="sd">    (brain.Connections object). Number of layers and number of neurons can be specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neurons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connections</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param neurons: pandas dataframe</span>
<span class="sd">        :param connections: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Brain: Creating littlefish.core.fish.Brain object ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">neurons</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">connections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_brain</span> <span class="o">=</span> <span class="n">generate_minimal_brain</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span> <span class="o">=</span> <span class="n">min_brain</span><span class="o">.</span><span class="n">get_neurons</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="n">min_brain</span><span class="o">.</span><span class="n">get_connections</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span> <span class="o">=</span> <span class="n">neurons</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span> <span class="o">=</span> <span class="n">connections</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_integrity</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: littlefish.core.fish.Brain created successfully.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;littlefish.brain.Brain object&#39;</span>

<div class="viewcode-block" id="Brain.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Brain</span><span class="p">(</span><span class="n">neurons</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_neurons</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">connections</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_connections</span><span class="p">()))</span></div>

<div class="viewcode-block" id="Brain.get_neurons"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_neurons">[docs]</a>    <span class="k">def</span> <span class="nf">get_neurons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">layer_num</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">])))</span> <span class="o">+</span> <span class="mi">1</span>

<div class="viewcode-block" id="Brain.get_layer_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_layer_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_layer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: layer type (str) given the layer number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input layer number should be integer.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;eye&#39;</span>
        <span class="k">elif</span> <span class="n">layer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;muscle&#39;</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">layer</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;hidden&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;layer number out of range.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Brain.get_neuron_type"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_neuron_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_neuron_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return neuron type as a pair of strings given the index in self._neurons</span>

<span class="sd">        :param ind: int</span>
<span class="sd">        :return: for eyes : (&#39;eye&#39;, type + short of direction)</span>
<span class="sd">                 for hidden neurons: (&#39;hidden&#39;, str(layer))</span>
<span class="sd">                 for muscles (&#39;muscle&#39;, short of direction)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># self.check_integrity_neurons()</span>

        <span class="n">curr_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">curr_layer</span> <span class="o">=</span> <span class="n">curr_row</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">curr_layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># eye layer</span>
            <span class="n">curr_dir</span><span class="p">,</span> <span class="n">curr_type</span> <span class="o">=</span> <span class="n">get_eye_type</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="s1">&#39;eye&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="n">curr_type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">curr_layer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># muscle layer</span>
            <span class="n">curr_dir</span> <span class="o">=</span> <span class="n">get_muscle_direction</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="s1">&#39;muscle&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="n">curr_dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">curr_layer</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">curr_layer_num</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">curr_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">curr_neuron_num</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">curr_row</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">util</span><span class="o">.</span><span class="n">short</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">),</span> <span class="n">curr_layer_num</span><span class="p">,</span> <span class="n">curr_neuron_num</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;layer number out of range.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Brain.get_connections"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_connections">[docs]</a>    <span class="k">def</span> <span class="nf">get_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span></div>

<div class="viewcode-block" id="Brain.get_postsynaptic_neuron_inds"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_postsynaptic_neuron_inds">[docs]</a>    <span class="k">def</span> <span class="nf">get_postsynaptic_neuron_inds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neuron_ind</span><span class="p">):</span>

        <span class="n">neuron_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">neuron_layer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: invalid layer. less than 0.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">neuron_layer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: cannot fine postsynaptic neuron of neurons in muscle layer.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">postsynaptic_neuron_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">neuron_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">postsynaptic_neuron_ind</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">postsynaptic_neuron_ind</span></div>

<div class="viewcode-block" id="Brain.get_presynaptic_neuron_inds"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_presynaptic_neuron_inds">[docs]</a>    <span class="k">def</span> <span class="nf">get_presynaptic_neuron_inds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neuron_ind</span><span class="p">):</span>

        <span class="n">neuron_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">neuron_layer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: invalid layer. less than 0.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">neuron_layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: cannot fine presynaptic neuron of neurons in eye layer.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">presynaptic_neuron_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">neuron_layer</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">presynaptic_neuron_ind</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">presynaptic_neuron_ind</span></div>

<div class="viewcode-block" id="Brain.get_single_connection"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_single_connection">[docs]</a>    <span class="k">def</span> <span class="nf">get_single_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_neuron_ind</span><span class="p">,</span> <span class="n">post_neuron_ind</span><span class="p">):</span>

        <span class="n">pre_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pre_neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]))</span>
        <span class="n">post_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">post_neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">post_layer</span> <span class="o">-</span> <span class="n">pre_layer</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;Brain: presynaptic layer&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and postsynaptic layer&#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">post_layer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; do not form connections.&#39;</span><span class="p">)</span>

        <span class="n">conn_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">post_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">conn_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">post_neuron_ind</span><span class="p">,</span> <span class="n">pre_neuron_ind</span><span class="p">]</span></div>

<div class="viewcode-block" id="Brain.get_neuron_inds_in_layer"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_neuron_inds_in_layer">[docs]</a>    <span class="k">def</span> <span class="nf">get_neuron_inds_in_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return a list of sorted neuron_indices of all neurons in a given layer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">inds</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inds</span></div>

<div class="viewcode-block" id="Brain.check_integrity"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.check_integrity">[docs]</a>    <span class="k">def</span> <span class="nf">check_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check integrity of object data structure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: checking integrity of attrbitue data structure ...&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_integrity_neurons</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_integrity_connection</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: integrity checking finished. All pass.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Brain.check_integrity_neurons"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.check_integrity_neurons">[docs]</a>    <span class="k">def</span> <span class="nf">check_integrity_neurons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">check_df_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: the indices of self._neurons are not starting at 0 and increasing with step 1.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: the indices of self._neurons are starting at 0 and increasing with step 1. PASS.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">layer</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neuron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">curr_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]))</span>
            <span class="n">curr_neuron_ind</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curr_layer</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: the &quot;layer&quot; in self._neurons is not in ascending order.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">curr_layer</span> <span class="o">==</span> <span class="n">layer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">curr_neuron_ind</span> <span class="o">!=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: the &quot;neuron_ind&quot; in self._neurons is not in ascending by step 1 for&#39;</span>
                                     <span class="s1">&#39; each &quot;layer&quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layer</span> <span class="o">=</span> <span class="n">curr_layer</span>
                <span class="k">if</span> <span class="n">curr_neuron_ind</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: the &quot;neuron_ind&quot; in self._neurons does not start with 0 for each &#39;</span>
                                     <span class="s1">&#39;&quot;layer&quot;.&#39;</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">curr_layer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># eye layer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;littlefish.brain.Eye object&#39;</span> <span class="ow">or</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;littlefish.brain.Eye2 object&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: non-eye object in eye layer.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">curr_layer</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># muscle layer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;littlefish.brain.Muscle object&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: non-muscle object in muscle layer.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># hidden layer</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;littlefish.brain.Neuron object&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: non-neuron object in hidden layer.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: the &quot;layer&quot; of self._neurons is in a non-descending order. PASS&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: the &quot;neuron_ind&quot; of self._neurons for each layer is ascending from 0 by step 1. PASS&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: eyes in eye layer, muscles in muscle layer, neurons in hidden layer. PASS&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Brain.check_integrity_connection"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.check_integrity_connection">[docs]</a>    <span class="k">def</span> <span class="nf">check_integrity_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">matching_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">matching_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">matching_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">conn_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">conn_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">conn_keys</span> <span class="o">==</span> <span class="n">matching_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: invalid keys in self._connections.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: valid keys in self._connections. PASS&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conn_keys</span><span class="p">:</span>
            <span class="n">pre_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="mi">4</span><span class="p">])</span>
            <span class="n">post_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span> <span class="mi">9</span><span class="p">])</span>
            <span class="n">curr_conn_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">pre_neuron_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neuron_inds_in_layer</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">)</span>
            <span class="n">post_neuron_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neuron_inds_in_layer</span><span class="p">(</span><span class="n">post_layer</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">pre_neuron_ind</span><span class="p">,</span> <span class="n">curr_conn_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: connections dataframe &#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; does not have valid column name.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">post_neuron_ind</span><span class="p">,</span> <span class="n">curr_conn_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: connections dataframe &#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39; does not have valid index name.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Brain: dataframes in self._connections have valid column and index names. PASS&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Brain.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">action_histories</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="p">,</span> <span class="n">body_position</span><span class="p">,</span> <span class="n">terrain_map</span><span class="p">,</span> <span class="n">food_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fish_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param t_point: int, current time stamp of time unit axis</span>
<span class="sd">        :param action_histories: data frame of lists, each list is the action history of a particular neuron, in the</span>
<span class="sd">                                 same order as self._neurons data frame, columns = [&#39;action_history&#39;]</span>
<span class="sd">        :param psp_waveforms: 2d-array of floats, psp waveforms of all neurons in the brain, each row represents one</span>
<span class="sd">                              neuron in the same order as self._neurons data frame, each column represents a time point</span>
<span class="sd">        :param body_position: tuple of two ints, (row, col), current position of body center of the fish</span>
<span class="sd">        :param terrain_map: 2d array, with only 0s (water) and 1s (land). represents the land scape of the world</span>
<span class="sd">        :param food_map: 2d array, with only 0s (no food) and 1s (food). represents the distribution of food</span>
<span class="sd">        :param fish_map: not fully implemented right now.</span>
<span class="sd">        :return: movement_attempt: 2-d array, np.uint8, (row, col), representing the movement attempt, be careful, this</span>
<span class="sd">                                   may not represent the actual movement, it will be evaluated by the fish object</span>
<span class="sd">                                   (fish class) containing this brain to see if the movement is possible. if the fish</span>
<span class="sd">                                   is hitting the edge the world map, then the it will not move out of the map</span>
<span class="sd">                                   None: no movement has been attempted,</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">movement_attempt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neuron</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># eye layer</span>
                <span class="n">curr_eye</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">get_input_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;terrain&#39;</span><span class="p">:</span>
                    <span class="n">is_fire</span> <span class="o">=</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="n">action_histories</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                           <span class="n">body_position</span><span class="o">=</span><span class="n">body_position</span><span class="p">,</span> <span class="n">input_map</span><span class="o">=</span><span class="n">terrain_map</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">get_input_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;food&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">food_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">is_fire</span> <span class="o">=</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span>
                                               <span class="n">action_history</span><span class="o">=</span><span class="n">action_histories</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;action_history&#39;</span><span class="p">],</span>
                                               <span class="n">body_position</span><span class="o">=</span><span class="n">body_position</span><span class="p">,</span> <span class="n">input_map</span><span class="o">=</span><span class="n">food_map</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">is_fire</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">get_input_type</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fish&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fish_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">is_fire</span> <span class="o">=</span> <span class="n">curr_eye</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span>
                                               <span class="n">action_history</span><span class="o">=</span><span class="n">action_histories</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;action_history&#39;</span><span class="p">],</span>
                                               <span class="n">body_position</span><span class="o">=</span><span class="n">body_position</span><span class="p">,</span> <span class="n">input_map</span><span class="o">=</span><span class="n">fish_map</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">is_fire</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: the input_type of eye should be one of the following:&#39;</span>
                                     <span class="s1">&#39;&quot;terrain&quot;, &quot;food&quot; or &quot;fish&quot;.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_fire</span><span class="p">:</span>  <span class="c1"># the current eye fires</span>
                    <span class="c1"># print(&#39;eye spike&#39;)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_fire</span><span class="p">(</span><span class="n">presynaptic_neuron_ind</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># hidden layer</span>
                <span class="n">curr_neuron</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">]</span>
                <span class="n">is_fire</span> <span class="o">=</span> <span class="n">curr_neuron</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">action_history</span><span class="o">=</span><span class="n">action_histories</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;action_history&#39;</span><span class="p">],</span>
                                          <span class="n">probability_input</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">t_point</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">is_fire</span><span class="p">:</span>
                    <span class="c1"># print(&#39;neuron spike&#39;)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">neuron_fire</span><span class="p">(</span><span class="n">presynaptic_neuron_ind</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># muscle layer</span>
                <span class="n">curr_muscle</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">]</span>
                <span class="n">curr_movement_attempt</span> <span class="o">=</span> <span class="n">curr_muscle</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span>
                                                        <span class="n">action_history</span><span class="o">=</span><span class="n">action_histories</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;action_history&#39;</span><span class="p">],</span>
                                                        <span class="n">probability_input</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">t_point</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">curr_movement_attempt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># print(&#39;muscle spike&#39;)</span>
                    <span class="n">movement_attempt</span> <span class="o">=</span> <span class="n">movement_attempt</span> <span class="o">+</span> <span class="n">curr_movement_attempt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Brain: neuron at index&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; has invalid layer location.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">movement_attempt</span></div>

<div class="viewcode-block" id="Brain.neuron_fire"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.neuron_fire">[docs]</a>    <span class="k">def</span> <span class="nf">neuron_fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">presynaptic_neuron_ind</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        updata all corresponding psp waveforms when a presynaptic neuron (only in eye layer and hidden layer) fires</span>

<span class="sd">        :param presynaptic_neuron_ind: int, the index of presynaptic neuron in self._neurons</span>
<span class="sd">        :param t_point: int, time point in time unit axis of the action</span>
<span class="sd">        :param psp_waveforms: 2d-array of floats, psp waveforms of all neurons in the brain, each row represents one</span>
<span class="sd">                              neuron in the same order as self._neurons data frame, each column represents a time point</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">neuron_layer</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">presynaptic_neuron_ind</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]))</span>

        <span class="c1"># ========================= slower but better method =====================================================</span>
        <span class="c1"># if 0 &lt;= neuron_layer &lt; self.layer_num - 1:  # eye layer or hidden layer</span>
        <span class="c1">#     curr_conn_df = self._connections[&#39;L&#39; + util.int2str(neuron_layer, 3) +</span>
        <span class="c1">#                                      &#39;_L&#39; + util.int2str(neuron_layer + 1, 3)]</span>
        <span class="c1">#     postsynaptic_neuron_inds = self.get_postsynaptic_neuron_inds(neuron_ind=presynaptic_neuron_ind)</span>
        <span class="c1">#</span>
        <span class="c1">#     for postsynaptic_neuron_ind in postsynaptic_neuron_inds:</span>
        <span class="c1">#         curr_connection = curr_conn_df.loc[postsynaptic_neuron_ind, presynaptic_neuron_ind]</span>
        <span class="c1">#         curr_connection.act(t_point=t_point, postsynaptic_index=postsynaptic_neuron_ind,</span>
        <span class="c1">#                             psp_waveforms=psp_waveforms)</span>
        <span class="c1"># elif neuron_layer == self.layer_num - 1:  # muscle layer</span>
        <span class="c1">#     print(&#39;Brain: a firing of a muscle has no effect on brain itself. Please use Muscle.act() method to &#39;</span>
        <span class="c1">#           &#39;generate movement attempt.&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     raise ValueError(&#39;Brain: neuron at index&#39; + str(presynaptic_neuron_ind) + &#39; has invalid layer location.&#39;)</span>
        <span class="c1"># ========================= slower but better method =====================================================</span>

        <span class="c1"># ========================= faster but unsafe method =====================================================</span>
        <span class="n">curr_conn_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">neuron_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">neuron_layer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="n">postsynaptic_neuron_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postsynaptic_neuron_inds</span><span class="p">(</span><span class="n">neuron_ind</span><span class="o">=</span><span class="n">presynaptic_neuron_ind</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">postsynaptic_neuron_ind</span> <span class="ow">in</span> <span class="n">postsynaptic_neuron_inds</span><span class="p">:</span>
            <span class="n">curr_connection</span> <span class="o">=</span> <span class="n">curr_conn_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">postsynaptic_neuron_ind</span><span class="p">,</span> <span class="n">presynaptic_neuron_ind</span><span class="p">]</span>
            <span class="n">curr_connection</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">postsynaptic_index</span><span class="o">=</span><span class="n">postsynaptic_neuron_ind</span><span class="p">,</span>
                                <span class="n">psp_waveforms</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">)</span></div>
        <span class="c1"># ========================= faster but unsafe method =====================================================</span>

<div class="viewcode-block" id="Brain.get_all_presynaptic_neuron_indices"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_all_presynaptic_neuron_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_presynaptic_neuron_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get indices of all presynaptic neurons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">layer_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">layer_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="n">ind</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span></div>

<div class="viewcode-block" id="Brain.get_all_postsynaptic_neuron_indices"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_all_postsynaptic_neuron_indices">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_postsynaptic_neuron_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get indices of all postsynaptic neurons</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="n">ind</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span></div>

<div class="viewcode-block" id="Brain.get_connection_matrices"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.get_connection_matrices">[docs]</a>    <span class="k">def</span> <span class="nf">get_connection_matrices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_layer</span><span class="p">,</span> <span class="n">post_layer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return several numpy arrays each represent one parameter of all connections between a presynaptic layer and</span>
<span class="sd">        a postsynaptic layer, each row is a postsynaptic neuron, each column is a presynaptic neuron</span>

<span class="sd">        :param pre_layer: int, layer number of presynaptic layer</span>
<span class="sd">        :param post_layer: int, layer number of postsynaptic layer</span>
<span class="sd">        :return rows: list of ints, postsynaptic neuron inds for each row</span>
<span class="sd">        :return cols: list of ints, presynaptic neuron inds for each column</span>
<span class="sd">        :return latencies: amplitudes, rise_times, decay_times: matrices for each connection parameter as described</span>
<span class="sd">                           above</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neuron_inds_in_layer</span><span class="p">(</span><span class="n">post_layer</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neuron_inds_in_layer</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">)</span>

        <span class="n">latencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
        <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">rise_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>
        <span class="n">decay_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint</span><span class="p">)</span>

        <span class="n">conn_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connections</span><span class="p">[</span><span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">post_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conn_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conn_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">latencies</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_latency</span><span class="p">()</span>
                <span class="n">amplitudes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_amplitude</span><span class="p">()</span>
                <span class="n">rise_times</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">()</span>
                <span class="n">decay_times</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">get_decay_time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">latencies</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">,</span> <span class="n">rise_times</span><span class="p">,</span> <span class="n">decay_times</span></div>

<div class="viewcode-block" id="Brain.to_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.to_h5_group">[docs]</a>    <span class="k">def</span> <span class="nf">to_h5_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_group</span><span class="p">):</span>

        <span class="n">neuron_group</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;neurons&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">neuron_df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">neuron_name</span> <span class="o">=</span> <span class="s1">&#39;neuron_&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">curr_neuron_group</span> <span class="o">=</span> <span class="n">neuron_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">neuron_name</span><span class="p">)</span>
            <span class="n">neuron_df</span><span class="p">[</span><span class="s1">&#39;neuron&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_h5_group</span><span class="p">(</span><span class="n">curr_neuron_group</span><span class="p">)</span>
            <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neuron_df</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
            <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neuron_df</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span>

        <span class="n">connection_group</span> <span class="o">=</span> <span class="n">h5_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;connections&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pre_layer</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer_num</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">post_layer</span> <span class="o">=</span> <span class="n">pre_layer</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">curr_connection_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_connection_matrices</span><span class="p">(</span><span class="n">pre_layer</span><span class="o">=</span><span class="n">pre_layer</span><span class="p">,</span> <span class="n">post_layer</span><span class="o">=</span><span class="n">post_layer</span><span class="p">)</span>

            <span class="n">curr_layer_group</span> <span class="o">=</span> <span class="n">connection_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">pre_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
                                                             <span class="s1">&#39;_L&#39;</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">int2str</span><span class="p">(</span><span class="n">post_layer</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;doc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rows: indices of postsynatpic neurons in the neuron group; &#39;</span> \
                                            <span class="s1">&#39;cols: indices of presynaptic neurons in the neuron group.&#39;</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;latencies_tu&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;amplitudes&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rise_times_tu&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">curr_layer_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;decay_times_tu&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">curr_connection_matrices</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span></div>

<div class="viewcode-block" id="Brain.from_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.from_h5_group">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_h5_group</span><span class="p">(</span><span class="n">h5_group</span><span class="p">):</span>
        <span class="n">neurons</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron_ind&#39;</span><span class="p">,</span> <span class="s1">&#39;neuron&#39;</span><span class="p">])</span>

        <span class="n">neurons_group</span> <span class="o">=</span> <span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;neurons&#39;</span><span class="p">]</span>
        <span class="n">neuron_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">neurons_group</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">neuron_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">neuron_name</span> <span class="ow">in</span> <span class="n">neuron_names</span><span class="p">:</span>
            <span class="n">curr_neuron_group</span> <span class="o">=</span> <span class="n">neurons_group</span><span class="p">[</span><span class="n">neuron_name</span><span class="p">]</span>
            <span class="n">curr_layer</span> <span class="o">=</span> <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
            <span class="n">curr_neuron_ind</span> <span class="o">=</span> <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_ind&#39;</span><span class="p">]</span>
            <span class="n">curr_ind</span> <span class="o">=</span> <span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span>

            <span class="n">curr_neuron_type</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">curr_neuron_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;neuron_type&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">curr_neuron_type</span> <span class="o">==</span> <span class="s1">&#39;neuron&#39;</span><span class="p">:</span>
                <span class="n">curr_neuron</span> <span class="o">=</span> <span class="n">Neuron</span><span class="o">.</span><span class="n">from_h5_group</span><span class="p">(</span><span class="n">curr_neuron_group</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">curr_neuron_type</span> <span class="o">==</span> <span class="s1">&#39;eye&#39;</span><span class="p">:</span>
                <span class="n">curr_neuron</span> <span class="o">=</span> <span class="n">Eye</span><span class="o">.</span><span class="n">from_h5_group</span><span class="p">(</span><span class="n">curr_neuron_group</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">curr_neuron_type</span> <span class="o">==</span> <span class="s1">&#39;muscle&#39;</span><span class="p">:</span>
                <span class="n">curr_neuron</span> <span class="o">=</span> <span class="n">Muscle</span><span class="o">.</span><span class="n">from_h5_group</span><span class="p">(</span><span class="n">curr_neuron_group</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;Brain: fail to load neuron. &quot;neuron_type&quot; attribute should be one of the &#39;</span>
                                  <span class="s1">&#39;following: &quot;eye&quot;, &quot;neuron&quot; or &quot;muscle&quot;.&#39;</span><span class="p">)</span>

            <span class="n">neurons</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">curr_ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">curr_layer</span><span class="p">,</span> <span class="n">curr_neuron_ind</span><span class="p">,</span> <span class="n">curr_neuron</span><span class="p">]</span>

        <span class="n">connections</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">connections_group</span> <span class="o">=</span> <span class="n">h5_group</span><span class="p">[</span><span class="s1">&#39;connections&#39;</span><span class="p">]</span>
        <span class="n">connections_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">connections_group</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">connections_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">connections_name</span> <span class="ow">in</span> <span class="n">connections_names</span><span class="p">:</span>
            <span class="n">curr_conn_group</span> <span class="o">=</span> <span class="n">connections_group</span><span class="p">[</span><span class="n">connections_name</span><span class="p">]</span>
            <span class="n">curr_inds</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">curr_cols</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;cols&#39;</span><span class="p">]</span>
            <span class="n">curr_amplitudes</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="p">[</span><span class="s1">&#39;amplitudes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">curr_decay_times</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="p">[</span><span class="s1">&#39;decay_times_tu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">curr_rise_times</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="p">[</span><span class="s1">&#39;rise_times_tu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="n">curr_latencies</span> <span class="o">=</span> <span class="n">curr_conn_group</span><span class="p">[</span><span class="s1">&#39;latencies_tu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

            <span class="n">curr_conn_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">curr_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">curr_inds</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_inds</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">curr_cols</span><span class="p">)):</span>
                    <span class="n">curr_conn_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="n">latency</span><span class="o">=</span><span class="n">curr_latencies</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                                                         <span class="n">amplitude</span><span class="o">=</span><span class="n">curr_amplitudes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                                                         <span class="n">rise_time</span><span class="o">=</span><span class="n">curr_rise_times</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span>
                                                         <span class="n">decay_time</span><span class="o">=</span><span class="n">curr_decay_times</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
            <span class="n">connections</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">connections_name</span><span class="p">:</span> <span class="n">curr_conn_df</span><span class="p">})</span>

        <span class="n">loaded_brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">(</span><span class="n">neurons</span><span class="o">=</span><span class="n">neurons</span><span class="p">,</span> <span class="n">connections</span><span class="o">=</span><span class="n">connections</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loaded_brain</span></div>

<div class="viewcode-block" id="Brain.generate_empty_action_histories"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.generate_empty_action_histories">[docs]</a>    <span class="k">def</span> <span class="nf">generate_empty_action_histories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a data frame with empty lists, each list is the action history of a particular neuron, in the same</span>
<span class="sd">                 order as self._neurons data frame, columns = [&#39;action_history&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">empty_action_histories</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">))])</span>
        <span class="n">empty_action_histories</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">empty_action_histories</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;action_history&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">empty_action_histories</span></div>

<div class="viewcode-block" id="Brain.generate_empty_psp_waveforms"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Brain.generate_empty_psp_waveforms">[docs]</a>    <span class="k">def</span> <span class="nf">generate_empty_psp_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulation_length</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param simulation_length: int, number of time points of the simulation</span>
<span class="sd">        :return: 2d-array of zeros, float32, psp waveforms of all neurons in the brain, each row represents one</span>
<span class="sd">                 neuron in the same order as self._neurons data frame, each column represents a time point</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neurons</span><span class="p">),</span> <span class="n">simulation_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Fish"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish">[docs]</a><span class="k">class</span> <span class="nc">Fish</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the main fish class</span>

<span class="sd">    a &#39;fish&#39; has a body occupies a 3x3 space.</span>

<span class="sd">    a &#39;fish&#39; has health point (goes down over time and increases after eating a food). fish moves around in a 2d</span>
<span class="sd">    landscape (2-d binary map, 0 represents water, 1 represents land), when hits land, health point will go down</span>
<span class="sd">    quickly.</span>

<span class="sd">    the purpose of simulation is to train the fish use its eyes, brain and muscles to avoid land and look for food.</span>

<span class="sd">    the simulation works on &quot;real-time&quot; basis on a time unit axis (consider one time unit is equivalent to 0.1</span>
<span class="sd">    millisecond.</span>

<span class="sd">    :attr _brain: a brain.Brain object</span>
<span class="sd">    :attr _max_health: float, maximum health point a fish can have</span>
<span class="sd">    :attr _health_decay_rate: float, the constant rate of health reduction, health point / time unit</span>
<span class="sd">    :attr _land_penalty_rate: float, the penalty of health point, if the fish&#39;s body covers land pixels (1s) in</span>
<span class="sd">                                   the terrain map, health point / (pixel * time unit)</span>
<span class="sd">    :attri _food_rate: float, the gaining of health point if fish&#39;s body covers food pixels (1s) in the food map,</span>
<span class="sd">                           health point / pixel. the food after taken will disappear, so no health gaining is a</span>
<span class="sd">                           transient event</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mother_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_health</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span> <span class="n">health_decay_rate</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
                 <span class="n">land_penalty_rate</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">food_rate</span><span class="o">=</span><span class="mf">20.</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param brain: a brain.Brain object</span>
<span class="sd">        :param max_health: float, maximum health point a fish can have</span>
<span class="sd">        :param health_decay_rate: float, the constant rate of health reduction, health point / time unit</span>
<span class="sd">        :param land_penalty_rate: float, the penalty of health point, if the fish&#39;s body covers land pixels (1s) in</span>
<span class="sd">                                  the terrain map, health point / (pixel * time unit)</span>
<span class="sd">        :param food_rate: float, the gaining of health point if fish&#39;s body covers food pixels (1s) in the food map,</span>
<span class="sd">                          health point / pixel. the food after taken will disappear, so no health gaining is a</span>
<span class="sd">                          transient event</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fish: Creating littlefish.core.fish.Fish object.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;test_fish&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">mother_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mother_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mother_name</span> <span class="o">=</span> <span class="n">mother_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_max_health</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_health</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_decay_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">health_decay_rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_land_penalty_rate</span> <span class="o">=</span> <span class="n">land_penalty_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_food_rate</span> <span class="o">=</span> <span class="n">food_rate</span>

        <span class="k">if</span> <span class="n">brain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">brain</span><span class="o">.</span><span class="n">check_integrity</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span> <span class="o">=</span> <span class="n">brain</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fish: littlefish.core.fish.Fish object created successfully.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Fish.copy"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return: a copy of self for i.e. mutation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Fish</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">mother_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mother_name</span><span class="p">(),</span> <span class="n">brain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_brain</span><span class="p">(),</span>
                    <span class="n">max_health</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_max_health</span><span class="p">(),</span> <span class="n">health_decay_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_health_decay_rate</span><span class="p">(),</span>
                    <span class="n">food_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_food_rate</span><span class="p">())</span></div>

<div class="viewcode-block" id="Fish.get_name"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>

<div class="viewcode-block" id="Fish.get_mother_name"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_mother_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_mother_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mother_name</span></div>

<div class="viewcode-block" id="Fish.get_brain"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_brain">[docs]</a>    <span class="k">def</span> <span class="nf">get_brain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span></div>

<div class="viewcode-block" id="Fish.get_max_health"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_max_health">[docs]</a>    <span class="k">def</span> <span class="nf">get_max_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_health</span></div>

<div class="viewcode-block" id="Fish.get_health_decay_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_health_decay_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_health_decay_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_health_decay_rate</span></div>

<div class="viewcode-block" id="Fish.get_land_penalty_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_land_penalty_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_land_penalty_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_land_penalty_rate</span></div>

<div class="viewcode-block" id="Fish.get_food_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.get_food_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_food_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_food_rate</span></div>

<div class="viewcode-block" id="Fish.set_name"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.set_name">[docs]</a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Fish.set_brain"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.set_brain">[docs]</a>    <span class="k">def</span> <span class="nf">set_brain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">brain</span><span class="p">):</span>
        <span class="n">brain</span><span class="o">.</span><span class="n">check_integrity</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span> <span class="o">=</span> <span class="n">brain</span></div>

<div class="viewcode-block" id="Fish.set_food_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.set_food_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_food_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">food_rate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_food_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">food_rate</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fish.set_health_decay_rate"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.set_health_decay_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_health_decay_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">health_decay_rate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_health_decay_rate</span> <span class="o">=</span> <span class="n">health_decay_rate</span></div>

<div class="viewcode-block" id="Fish.act"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.act">[docs]</a>    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_point</span><span class="p">,</span> <span class="n">curr_position</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">,</span> <span class="n">action_histories</span><span class="p">,</span> <span class="n">psp_waveforms</span><span class="p">,</span> <span class="n">terrain_map</span><span class="p">,</span>
            <span class="n">food_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fish_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        simulate the fish&#39;s action at a given time point</span>

<span class="sd">        :param t_point: non-negative int, time point</span>
<span class="sd">        :param curr_position: list or tuple of two non-negative integers, coordinates of fish center position,</span>
<span class="sd">                              [row, col]</span>
<span class="sd">        :param curr_health: positive float, health point at the beginning of t_point</span>
<span class="sd">        :param action_histories: data frame of lists, each list is the action history of a particular neuron, in the</span>
<span class="sd">                                 same order as self._neurons data frame, columns = [&#39;action_history&#39;], used by</span>
<span class="sd">                                 self._brain.act()</span>
<span class="sd">        :param psp_waveforms: 2d-array of floats, psp waveforms of all neurons in the brain, each row represents one</span>
<span class="sd">                              neuron in the same order as self._neurons data frame, each column represents a time point,</span>
<span class="sd">                              used by self._brain.act()</span>
<span class="sd">        :param terrain_map: 2d array, with only 0s (water) and 1s (land). represents the land scape of the world</span>
<span class="sd">        :param food_map: 2d array, with only 0s (no food) and 1s (food). represents the distribution of food</span>
<span class="sd">        :param fish_map: not fully implemented right now.</span>
<span class="sd">        :return updated_health: float, health point at the end of t_point</span>
<span class="sd">        :return movement_attempt: list of two integers, the attempt the fish is trying to move [row_shift, col_shift].</span>
<span class="sd">                                  None if updated_health is below 0 (fish is dead).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">updated_health</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">curr_health</span><span class="p">)</span>

        <span class="c1"># evaluate food</span>
        <span class="k">if</span> <span class="n">food_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">body_food_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_food</span><span class="p">(</span><span class="n">food_map</span><span class="o">=</span><span class="n">food_map</span><span class="p">,</span> <span class="n">curr_position</span><span class="o">=</span><span class="n">curr_position</span><span class="p">)</span>
            <span class="n">updated_health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eat_food</span><span class="p">(</span><span class="n">body_food_overlap</span><span class="o">=</span><span class="n">body_food_overlap</span><span class="p">,</span> <span class="n">curr_health</span><span class="o">=</span><span class="n">updated_health</span><span class="p">)</span>
            <span class="n">food_eated</span> <span class="o">=</span> <span class="n">body_food_overlap</span>

            <span class="c1"># update food map</span>
            <span class="n">food_map</span><span class="p">[</span><span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">food_eated</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># evaluate the extend of how much of the fish is on the land</span>
        <span class="n">body_land_overlap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_terrain</span><span class="p">(</span><span class="n">terrain_map</span><span class="o">=</span><span class="n">terrain_map</span><span class="p">,</span> <span class="n">curr_position</span><span class="o">=</span><span class="n">curr_position</span><span class="p">)</span>

        <span class="c1"># update current health with land penalty</span>
        <span class="n">updated_health</span> <span class="o">-=</span> <span class="n">body_land_overlap</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_land_penalty_rate</span>

        <span class="c1"># ----------------- not implemented --------------------------</span>
        <span class="c1"># if fish_map is not None:</span>
        <span class="c1">#     self._eval_fish(fish_map=fish_map)</span>
        <span class="c1"># ----------------- not implemented --------------------------</span>

        <span class="c1"># update health</span>
        <span class="n">updated_health</span> <span class="o">=</span> <span class="n">updated_health</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_health_decay_rate</span>

        <span class="k">if</span> <span class="n">updated_health</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># still alive</span>
            <span class="n">movement_attempt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">t_point</span><span class="o">=</span><span class="n">t_point</span><span class="p">,</span> <span class="n">action_histories</span><span class="o">=</span><span class="n">action_histories</span><span class="p">,</span>
                                               <span class="n">psp_waveforms</span><span class="o">=</span><span class="n">psp_waveforms</span><span class="p">,</span> <span class="n">body_position</span><span class="o">=</span><span class="n">curr_position</span><span class="p">,</span>
                                               <span class="n">terrain_map</span><span class="o">=</span><span class="n">terrain_map</span><span class="p">,</span> <span class="n">food_map</span><span class="o">=</span><span class="n">food_map</span><span class="p">,</span>
                                               <span class="n">fish_map</span><span class="o">=</span><span class="n">fish_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">movement_attempt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">updated_health</span><span class="p">,</span> <span class="n">movement_attempt</span><span class="p">,</span> <span class="n">food_eated</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eval_terrain</span><span class="p">(</span><span class="n">terrain_map</span><span class="p">,</span> <span class="n">curr_position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the coverage of fish body on terrain map, return the sum of all terrain pixels that are covered by</span>
<span class="sd">        the fish body</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">terrain_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fish: _eval_terrain failure. terrain_map is None.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_body</span> <span class="o">=</span> <span class="n">terrain_map</span><span class="p">[</span><span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">body_land_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">curr_body</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">body_land_overlap</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eval_food</span><span class="p">(</span><span class="n">food_map</span><span class="p">,</span> <span class="n">curr_position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find out how many foods are covered by the fish body</span>

<span class="sd">        :param food_map: 2d array, binary map of current food</span>
<span class="sd">        :param curr_position: tuple of two positive ints, (row, col) of current location of fish</span>
<span class="sd">        :return: non-negative int, number of food taken</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">curr_body</span> <span class="o">=</span> <span class="n">food_map</span><span class="p">[</span><span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">curr_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">body_food_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">curr_body</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">body_food_overlap</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eval_fish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fish_map</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;currently not implemented&quot;&quot;&quot;</span>

        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_eat_food</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body_food_overlap</span><span class="p">,</span> <span class="n">curr_health</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        count the number of food to be taken, add relevant HP to curr_health, but not exceed the maximum health</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">body_food_overlap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">curr_health</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updated_health</span> <span class="o">=</span> <span class="n">curr_health</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_food_rate</span> <span class="o">*</span> <span class="n">body_food_overlap</span>
            <span class="k">if</span> <span class="n">updated_health</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_health</span><span class="p">:</span>
                <span class="n">updated_health</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_health</span>
            <span class="k">return</span> <span class="n">updated_health</span>

<div class="viewcode-block" id="Fish.to_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.to_h5_group">[docs]</a>    <span class="k">def</span> <span class="nf">to_h5_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5_grp</span><span class="p">):</span>

        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;mother_name&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mother_name</span><span class="p">)</span>
        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;max_health&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_health</span><span class="p">)</span>
        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;health_decay_rate_per_tu&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_health_decay_rate</span><span class="p">)</span>
        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;land_penalty_rate_per_pixel_tu&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_land_penalty_rate</span><span class="p">)</span>
        <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;food_rate_per_pixel&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_food_rate</span><span class="p">)</span>
        <span class="n">brain_group</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;brain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_brain</span><span class="o">.</span><span class="n">to_h5_group</span><span class="p">(</span><span class="n">brain_group</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fish.from_h5_group"><a class="viewcode-back" href="../../../littlefish.core.fish.html#littlefish.core.fish.Fish.from_h5_group">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_h5_group</span><span class="p">(</span><span class="n">h5_grp</span><span class="p">):</span>

        <span class="n">brain_grp</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;brain&#39;</span><span class="p">]</span>
        <span class="n">curr_brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="o">.</span><span class="n">from_h5_group</span><span class="p">(</span><span class="n">brain_grp</span><span class="p">)</span>
        <span class="n">curr_name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">curr_mother_name</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;mother_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">curr_max_health</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;max_health&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">curr_health_decay_rate</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;health_decay_rate_per_tu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">curr_land_penalty_rate</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;land_penalty_rate_per_pixel_tu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">curr_food_rate</span> <span class="o">=</span> <span class="n">h5_grp</span><span class="p">[</span><span class="s1">&#39;food_rate_per_pixel&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="n">curr_fish</span> <span class="o">=</span> <span class="n">Fish</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">curr_name</span><span class="p">,</span> <span class="n">mother_name</span><span class="o">=</span><span class="n">curr_mother_name</span><span class="p">,</span> <span class="n">brain</span><span class="o">=</span><span class="n">curr_brain</span><span class="p">,</span> <span class="n">max_health</span><span class="o">=</span><span class="n">curr_max_health</span><span class="p">,</span>
                         <span class="n">health_decay_rate</span><span class="o">=</span><span class="n">curr_health_decay_rate</span><span class="p">,</span> <span class="n">land_penalty_rate</span><span class="o">=</span><span class="n">curr_land_penalty_rate</span><span class="p">,</span>
                         <span class="n">food_rate</span><span class="o">=</span><span class="n">curr_food_rate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">curr_fish</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># starting_position = (10, 10)</span>
    <span class="c1"># terrain_map = np.zeros((20, 20), _dtype=np.uint8)</span>
    <span class="c1">#</span>
    <span class="c1"># fish = Fish()</span>
    <span class="c1"># fish.initialize_simulation(starting_position=starting_position, terrain_map=terrain_map)</span>
    <span class="c1"># print(fish.get_curr_health())</span>
    <span class="c1"># print(fish.get_curr_position())</span>
    <span class="c1"># fish.act(0, terrain_map=terrain_map)</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># save_path = r&quot;G:\little_fish_test\fish.hdf5&quot;</span>
    <span class="c1"># if os.path.isfile(save_path):</span>
    <span class="c1">#     os.remove(save_path)</span>
    <span class="c1"># fish_group = h5py.File(save_path).create_group(&#39;fish&#39;)</span>
    <span class="c1">#</span>
    <span class="c1"># fish = Fish()</span>
    <span class="c1"># fish.to_h5_group(fish_group)</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># dfile = h5py.File(r&quot;F:\littlefish\test_folder\neuron_test.hdf5&quot;)</span>
    <span class="c1"># neuron_group = dfile.create_group(&#39;test_neuron&#39;)</span>
    <span class="c1"># neuron = Neuron()</span>
    <span class="c1"># for i in range(SIMULATION_LENGTH):</span>
    <span class="c1">#     neuron.act(i)</span>
    <span class="c1"># neuron.to_h5_group(neuron_group)</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># connection = Connection(amplitude=10, latency=5)</span>
    <span class="c1"># print(connection.get_psp())</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># SIMULATION_LENGTH = 50</span>
    <span class="c1"># postsynaptic_input = np.zeros(SIMULATION_LENGTH)</span>
    <span class="c1"># connection = Connection(amplitude=10, latency=5, rise_time=5, decay_time=10)</span>
    <span class="c1"># connection.act(2, postsynaptic_input)</span>
    <span class="c1"># print(postsynaptic_input)</span>
    <span class="c1"># connection.act(4, postsynaptic_input)</span>
    <span class="c1"># print(postsynaptic_input)</span>
    <span class="c1"># connection.act(40, postsynaptic_input)</span>
    <span class="c1"># print(postsynaptic_input)</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># SIMULATION_LENGTH = 5000</span>
    <span class="c1"># neuron_pre = Neuron(baseline_rate=0.005)</span>
    <span class="c1"># neuron_post = Neuron(baseline_rate=0.000)</span>
    <span class="c1"># connection = Connection(amplitude=1, latency=5, rise_time=1, decay_time=1)</span>
    <span class="c1">#</span>
    <span class="c1"># postsynaptic_input = np.zeros(SIMULATION_LENGTH)</span>
    <span class="c1">#</span>
    <span class="c1"># for i in range(SIMULATION_LENGTH):</span>
    <span class="c1">#</span>
    <span class="c1">#     is_firing = neuron_pre.act(i)</span>
    <span class="c1">#     if is_firing:</span>
    <span class="c1">#         connection.act(i, postsynaptic_input)</span>
    <span class="c1">#     neuron_post.act(i, probability_input=postsynaptic_input[i])</span>
    <span class="c1">#</span>
    <span class="c1"># spk_train_pre = neuron_pre.get_action_history()</span>
    <span class="c1"># spk_train_post = neuron_post.get_action_history()</span>
    <span class="c1">#</span>
    <span class="c1"># # print(postsynaptic_input)</span>
    <span class="c1"># print(len(spk_train_pre))</span>
    <span class="c1"># print(len(spk_train_post))</span>
    <span class="c1">#</span>
    <span class="c1"># ccg, t = util.discreat_crosscorrelation(np.array(spk_train_pre), np.array(spk_train_post))</span>
    <span class="c1"># plt.bar(t, ccg)</span>
    <span class="c1"># plt.show()</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># SIMULATION_LENGTH = 100000</span>
    <span class="c1">#</span>
    <span class="c1"># terrain_map = np.zeros((5, 5), _dtype=np.uint8)</span>
    <span class="c1"># terrain_map[3, 3] = 1</span>
    <span class="c1"># print(terrain_map)</span>
    <span class="c1">#</span>
    <span class="c1"># eye = Eye(position=(2, 3), direction=&#39;south&#39;)</span>
    <span class="c1"># print(eye._get_input(terrain_map=terrain_map))</span>
    <span class="c1">#</span>
    <span class="c1"># for i in range(SIMULATION_LENGTH):</span>
    <span class="c1">#     eye.act(i, terrain_map=terrain_map)</span>
    <span class="c1"># print(len(eye.get_action_history()))</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># SIMULATION_LENGTH = 20000</span>
    <span class="c1"># muscle = Muscle(direction=&#39;east&#39;, baseline_rate=0., refractory_period=5000)</span>
    <span class="c1"># movements = []</span>
    <span class="c1"># for i in range(SIMULATION_LENGTH):</span>
    <span class="c1">#     movement=muscle.act(i, probability_input=0.5, probability_base=0.1)</span>
    <span class="c1">#     if movement:</span>
    <span class="c1">#         movements.append(movement)</span>
    <span class="c1"># print(movements)</span>
    <span class="c1"># print(muscle.get_action_history())</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># brain = Brain()</span>
    <span class="c1"># neurons_df = brain.generate_default_neurons_df()</span>
    <span class="c1"># connections_df = brain.generate_default_connections_df(neurons_df)</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># SIMULATION_LENGTH = 100000</span>
    <span class="c1">#</span>
    <span class="c1"># terrain_map = np.zeros((5, 5), _dtype=np.uint8)</span>
    <span class="c1"># terrain_map[3, 3] = 1</span>
    <span class="c1"># print(terrain_map)</span>
    <span class="c1">#</span>
    <span class="c1"># eye = Eye2(direction=&#39;south&#39;)</span>
    <span class="c1"># position = (2, 3)</span>
    <span class="c1"># print(eye._get_input_pixels(position=position, terrain_map=terrain_map))</span>
    <span class="c1"># print(eye._get_input(position=position, terrain_map=terrain_map))</span>
    <span class="c1">#</span>
    <span class="c1"># for i in range(SIMULATION_LENGTH):</span>
    <span class="c1">#     eye.act(t_point=i, position=position, terrain_map=terrain_map)</span>
    <span class="c1"># print(len(eye.get_action_history()))</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># brain = Brain()</span>
    <span class="c1"># print(brain.has_action_histories())</span>
    <span class="c1"># brain._generate_empty_psp_waveforms()</span>
    <span class="c1"># print(brain.get_neuron_inds_in_layer(2))</span>
    <span class="c1"># print(brain.get_all_presynaptic_neuron_indices())</span>
    <span class="c1"># print(brain.get_all_postsynaptic_neuron_indices())</span>
    <span class="c1"># print(brain.get_eye_type(13))</span>
    <span class="c1"># print(brain.layer_num)</span>
    <span class="c1"># print(brain.get_postsynaptic_neuron_inds(8))</span>
    <span class="c1"># print(brain.get_presynaptic_neuron_inds(8))</span>
    <span class="c1"># print(brain.get_single_connection(8, 13))</span>
    <span class="c1"># print(brain.get_single_connection(8, 16))</span>
    <span class="c1"># print(brain.get_neuron_inds_in_layer(3))</span>
    <span class="c1"># #</span>
    <span class="c1"># test_file_path = r&quot;F:\littlefish\test_folder\brain_test.hdf5&quot;</span>
    <span class="c1"># if os.path.isfile(test_file_path):</span>
    <span class="c1">#     os.remove(test_file_path)</span>
    <span class="c1"># test_file = h5py.File(test_file_path)</span>
    <span class="c1"># brain_group = test_file.create_group(&#39;brain&#39;)</span>
    <span class="c1"># brain.to_h5_group(brain_group)</span>
    <span class="c1"># test_file.close()</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># test_file = h5py.File(r&quot;F:\littlefish\test_folder\brain_test.hdf5&quot;)</span>
    <span class="c1"># brain = Brain.from_h5_group(test_file[&#39;brain&#39;])</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># dfile = h5py.File(r&quot;F:\littlefish\test_folder\brain_test.hdf5&quot;)</span>
    <span class="c1"># neuron = Neuron.from_h5_group(dfile[&#39;brain/neurons/neuron_00008&#39;])</span>
    <span class="c1"># print(neuron.get_action_history())</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># bb = Brain()</span>
    <span class="c1"># print(bb)</span>
    <span class="c1"># print(len(bb.get_connections()))</span>
    <span class="c1"># print(bb.get_connections()[&#39;L000_L001&#39;])</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># mb = Brain()</span>
    <span class="c1"># eah = mb.generate_empty_action_histories()</span>
    <span class="c1"># print eah</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># min_brain = generate_minimal_brain()</span>
    <span class="c1"># print min_brain._neurons</span>
    <span class="c1"># =========================================================================================</span>

    <span class="c1"># =========================================================================================</span>
    <span class="c1"># generate_standard_fish()</span>
    <span class="c1"># =========================================================================================</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">for debug ...&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">littlefish 0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Jun Zhuang.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>